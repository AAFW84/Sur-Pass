<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SurPass - Control de Acceso</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Biblioteca HTML5-QR-Code para escaneo de códigos QR más confiable -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <!-- Librería jsQR -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    
    <style>
    /* =====================================================
   SURPASS - CSS COMPLETO MEJORADO
   Sistema de Control de Acceso con Evacuación
   Versión: 3.0 Optimizada
   ===================================================== */

/* =====================================================
   VARIABLES CSS Y TEMAS OPTIMIZADAS
   ===================================================== */
:root {
    /* Tema claro (por defecto) */
    --primary-color: #960018;
    --secondary-color: #43a047;
    --accent-color: #FFD700;
    --background-color: #FBD10D;
    --text-color: #333333;
    --light-color: #ffffff;
    --shadow-color: rgba(0, 0, 0, 0.3);
    --success-color: #4caf50;
    --error-color: #f44336;
    --warning-color: #ff9800;
    --info-color: #2196f3;
    --evacuation-color: #ff9800;
    --evacuation-urgent: #f44336;

    /* Variables para tema oscuro */
    --dark-primary-color: #a3001c;
    --dark-secondary-color: #388e3c;
    --dark-accent-color: #FFD700;
    --dark-background-color: #1a1a1a;
    --dark-text-color: #f0f0f0;
    --dark-light-color: #444444;
    --dark-shadow-color: rgba(0, 0, 0, 0.4);
    --dark-card-bg: #2d2d2d;
    --dark-input-bg: #3d3d3d;
    --dark-border-color: #4a4a4a;
    --dark-evacuation-color: #ff6b6b;
    --dark-evacuation-urgent: #ff5252;
    
    /* Animaciones */
    --transition-fast: 0.2s ease;
    --transition-normal: 0.3s ease;
    --transition-slow: 0.5s ease;
    
    /* Efectos glassmorphism */
    --glass-bg: rgba(255, 255, 255, 0.1);
    --glass-border: rgba(255, 255, 255, 0.2);
    --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);

    /* ✅ NUEVAS VARIABLES PARA OPTIMIZACIÓN DE TEMAS */
    --theme-bg: var(--background-color);
    --theme-text: var(--text-color);
    --theme-card-bg: var(--light-color);
    --theme-input-bg: rgba(255, 255, 255, 0.9);
    --theme-border: rgba(0, 0, 0, 0.1);
    --theme-shadow: rgba(0, 0, 0, 0.1);
}

/* ✅ APLICACIÓN AUTOMÁTICA DEL TEMA OSCURO */
.dark-theme {
    --theme-bg: var(--dark-background-color);
    --theme-text: var(--dark-text-color);
    --theme-card-bg: var(--dark-card-bg);
    --theme-input-bg: var(--dark-input-bg);
    --theme-border: var(--dark-border-color);
    --theme-shadow: rgba(0, 0, 0, 0.4);
}

/* =====================================================
   RESET Y ESTILOS BASE
   ===================================================== */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Arial', sans-serif;
    background: linear-gradient(135deg, var(--theme-bg) 0%, #f39c12 100%);
    color: var(--theme-text);
    line-height: 1.6;
    min-height: 100vh;
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    transition: all var(--transition-normal);
    position: relative;
}

.dark-theme body {
    background: linear-gradient(135deg, var(--dark-background-color) 0%, #2c3e50 100%);
}

/* Partículas de fondo animadas */
body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"><animate attributeName="cy" values="20;80;20" dur="3s" repeatCount="indefinite"/></circle><circle cx="60" cy="50" r="1.5" fill="rgba(255,255,255,0.08)"><animate attributeName="cy" values="50;10;50" dur="2s" repeatCount="indefinite"/></circle><circle cx="80" cy="30" r="1" fill="rgba(255,255,255,0.06)"><animate attributeName="cy" values="30;70;30" dur="2.5s" repeatCount="indefinite"/></circle></svg>') repeat;
    pointer-events: none;
    z-index: -1;
    opacity: 0.5;
}

.dark-theme body::before {
    opacity: 0.3;
}

/* =====================================================
   SISTEMA DE BOTONES UNIFICADO
   ===================================================== */

/* ✅ CLASE BASE UNIFICADA PARA TODOS LOS BOTONES */
.btn-base {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    text-decoration: none;
    transition: all var(--transition-normal);
    position: relative;
    overflow: hidden;
    font-family: inherit;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    min-width: 120px;
}

/* ✅ EFECTO SHINE UNIFICADO */
.btn-base::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: all 0.6s;
}

.btn-base:hover::before {
    left: 100%;
}

.btn-base:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.btn-base:active {
    transform: translateY(0);
}

/* ✅ VARIANTES DE COLOR */
.btn-primary {
    background: linear-gradient(135deg, #2196f3, #1976d2);
    color: white;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #42a5f5, #2196f3);
}

.btn-success {
    background: linear-gradient(135deg, #4caf50, #388e3c);
    color: white;
}

.btn-success:hover {
    background: linear-gradient(135deg, #66bb6a, #4caf50);
}

.btn-warning {
    background: linear-gradient(135deg, #ff9800, #f57c00);
    color: white;
}

.btn-warning:hover {
    background: linear-gradient(135deg, #ffb74d, #ff9800);
}

.btn-danger {
    background: linear-gradient(135deg, #f44336, #d32f2f);
    color: white;
}

.btn-danger:hover {
    background: linear-gradient(135deg, #ef5350, #f44336);
}

.btn-simulacro {
    background: linear-gradient(135deg, #7c3aed, #5b21b6);
    color: white;
}

.btn-simulacro:hover {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
}

.btn-secondary {
    background: linear-gradient(135deg, #6c757d, #495057);
    color: white;
}

.btn-secondary:hover {
    background: linear-gradient(135deg, #868e96, #6c757d);
}

/* ✅ VARIANTES DE TAMAÑO */
.btn-small {
    padding: 8px 16px;
    font-size: 14px;
    min-width: 80px;
}

.btn-large {
    padding: 16px 32px;
    font-size: 18px;
    min-width: 200px;
}

.btn-xl {
    padding: 20px 40px;
    font-size: 20px;
    min-width: 250px;
}

/* ✅ APLICAR CLASES BASE A ELEMENTOS EXISTENTES */
.btn, 
.evacuation-btn, 
.confirmation-button,
input[type="submit"] {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    text-decoration: none;
    transition: all var(--transition-normal);
    position: relative;
    overflow: hidden;
    font-family: inherit;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    min-width: 120px;
}

.btn::before, 
.evacuation-btn::before, 
.confirmation-button::before,
input[type="submit"]::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: all 0.6s;
}

.btn:hover::before, 
.evacuation-btn:hover::before, 
.confirmation-button:hover::before,
input[type="submit"]:hover::before {
    left: 100%;
}

.btn:hover, 
.evacuation-btn:hover, 
.confirmation-button:hover,
input[type="submit"]:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

/* ✅ VARIANTES ESPECÍFICAS PARA EVACUACIÓN */
.evacuation-btn {
    background: linear-gradient(135deg, #ff9800, #f57c00);
    color: white;
    border-left: 4px solid var(--evacuation-color);
    min-width: 180px;
}

.evacuation-btn:hover {
    background: linear-gradient(135deg, #ffb74d, #ff9800);
    transform: translateY(-2px) translateX(5px);
}

.evacuation-btn-confirm {
    background: linear-gradient(135deg, #4caf50, #388e3c);
    color: white;
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
}

.evacuation-btn-confirm:hover {
    background: linear-gradient(135deg, #66bb6a, #4caf50);
    box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
}

.evacuation-btn-close {
    background: linear-gradient(135deg, #f44336, #d32f2f);
    color: white;
    box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
}

.evacuation-btn-close:hover {
    background: linear-gradient(135deg, #ef5350, #f44336);
    box-shadow: 0 6px 16px rgba(244, 67, 54, 0.4);
}

.confirmation-button {
    padding: 10px 20px;
    font-size: 16px;
    min-width: 100px;
}

.confirm-yes {
    background: linear-gradient(135deg, #4caf50, #388e3c);
    color: white;
}

.confirm-yes:hover {
    background: linear-gradient(135deg, #66bb6a, #4caf50);
}

.confirm-no {
    background: linear-gradient(135deg, #f44336, #d32f2f);
    color: white;
}

.confirm-no:hover {
    background: linear-gradient(135deg, #ef5350, #f44336);
}

/* =====================================================
   SISTEMA DE ANIMACIONES UNIFICADO
   ===================================================== */

/* ✅ ANIMACIONES BASE REUTILIZABLES */
@keyframes pulse {
    0%, 100% { 
        transform: scale(1); 
        opacity: 1;
    }
    50% { 
        transform: scale(1.05); 
        opacity: 0.8;
    }
}

@keyframes pulseIntense {
    0%, 100% { 
        transform: scale(1); 
        opacity: 1;
        box-shadow: 0 0 10px rgba(255, 152, 0, 0.3);
    }
    50% { 
        transform: scale(1.15); 
        opacity: 0.9;
        box-shadow: 0 0 20px rgba(255, 152, 0, 0.6);
    }
}

@keyframes glow {
    0%, 100% { 
        filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.3));
        text-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
    }
    50% { 
        filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.6));
        text-shadow: 0 0 20px rgba(255, 255, 255, 0.6);
    }
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes bounce {
    0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
    40%, 43% { transform: translate3d(0,-10px,0); }
    70% { transform: translate3d(0,-5px,0); }
    90% { transform: translate3d(0,-2px,0); }
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}

@keyframes slideIn {
    from { 
        opacity: 0; 
        transform: translateY(30px); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0); 
    }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes headerWaves {
    0% { transform: rotate(0deg) translateX(0px); }
    100% { transform: rotate(360deg) translateX(30px); }
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-50px) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

@keyframes notificationSlideUp {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(50px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

@keyframes menuSlideIn {
    from {
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

@keyframes infoShimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

@keyframes buttonShine {
    0% { transform: translateX(-100%) rotate(45deg); }
    100% { transform: translateX(100%) rotate(45deg); }
}

@keyframes radioSelected {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1.2); }
}

@keyframes loadingPulse {
    0%, 100% { opacity: 0.7; }
    50% { opacity: 1; }
}

@keyframes countUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes stripesMove {
    0% { transform: translateX(-50px); }
    100% { transform: translateX(50px); }
}

@keyframes contentSlideUp {
    from {
        transform: translateY(50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes statusPulse {
    0%, 100% {
        transform: scale(1);
        box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
    }
    50% {
        transform: scale(1.05);
        box-shadow: 0 6px 16px rgba(255, 152, 0, 0.5);
    }
}

/* ✅ CLASES UTILITARIAS PARA ANIMACIONES */
.animate-pulse { animation: pulse 2s infinite; }
.animate-pulse-intense { animation: pulseIntense 2s infinite; }
.animate-glow { animation: glow 2s ease-in-out infinite alternate; }
.animate-spin { animation: spin 1s linear infinite; }
.animate-bounce { animation: bounce 0.6s ease; }
.animate-shake { animation: shake 0.5s ease-in-out; }
.animate-slide-in { animation: slideIn 0.4s ease-out; }
.animate-fade-in { animation: fadeIn 0.5s ease-in; }

/* =====================================================
   CLASES GENÉRICAS QUE SE ADAPTAN AL TEMA
   ===================================================== */
.theme-text {
    color: var(--theme-text);
}

.theme-bg {
    background: var(--theme-bg);
}

.theme-card {
    background: var(--theme-card-bg);
    color: var(--theme-text);
    border: 1px solid var(--theme-border);
    box-shadow: 0 2px 8px var(--theme-shadow);
}

.theme-input {
    background: var(--theme-input-bg);
    color: var(--theme-text);
    border: 1px solid var(--theme-border);
}

/* =====================================================
   CONTENEDOR PRINCIPAL
   ===================================================== */
.container {
    max-width: 100%;
    min-height: 100vh;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    position: relative;
    transition: all var(--transition-normal);
}

/* =====================================================
   HEADER Y TÍTULO
   ===================================================== */
.header {
    text-align: center;
    padding: 40px 0;
    background: linear-gradient(135deg, var(--primary-color) 0%, #b71c1c 100%);
    color: var(--light-color);
    border-radius: 0 0 30px 30px;
    position: relative;
    margin-bottom: 30px;
    box-shadow: var(--glass-shadow);
    transition: all var(--transition-normal);
}

.dark-theme .header {
    background: linear-gradient(135deg, var(--dark-primary-color) 0%, #1a1a1a 100%);
}

.header::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
    background-size: 30px 30px;
    animation: headerWaves 20s linear infinite;
    opacity: 0.5;
}

h1 {
    font-size: clamp(40px, 8vw, 80px);
    margin: 0;
    padding: 10px 0;
    color: var(--light-color);
    text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
    letter-spacing: 2px;
    transition: all var(--transition-normal);
    position: relative;
    z-index: 1;
    font-weight: 700;
    background: linear-gradient(45deg, #ffffff, #f0f0f0);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: glow 3s ease-in-out infinite alternate;
}

.dark-theme h1 {
    color: var(--dark-text-color);
    background: linear-gradient(45deg, #ffffff, #cccccc);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

/* =====================================================
   INDICADOR DE CONEXIÓN
   ===================================================== */
.conexion-indicador {
    position: absolute;
    top: 20px;
    left: 20px;
    padding: 8px 15px;
    border-radius: 25px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 16px;
    z-index: 50;
    transition: all var(--transition-normal);
    backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    font-weight: 600;
}

.conexion-indicador.online {
    background: rgba(76, 175, 80, 0.2);
    color: #4caf50;
    box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
}

.conexion-indicador.offline {
    background: rgba(244, 67, 54, 0.2);
    color: #f44336;
    box-shadow: 0 0 20px rgba(244, 67, 54, 0.3);
    animation: pulse 2s infinite;
}

.dark-theme .conexion-indicador.online {
    background: rgba(76, 175, 80, 0.3);
}

.dark-theme .conexion-indicador.offline {
    background: rgba(244, 67, 54, 0.3);
}

/* =====================================================
   MENÚ Y DROPDOWN
   ===================================================== */
.menu-button {
    position: absolute;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, rgba(76, 175, 80, 0.9), rgba(56, 142, 60, 0.9));
    color: var(--light-color);
    border: none;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    font-size: 24px;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    transition: all var(--transition-normal);
    z-index: 10000;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    min-width: 60px;
}

.menu-button:hover {
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.9), rgba(255, 152, 0, 0.9));
    transform: rotate(90deg);
    box-shadow: 0 12px 35px rgba(255, 193, 7, 0.4);
}

.menu-dropdown {
    position: fixed;
    top: 100px;
    right: 20px;
    background: rgba(255, 255, 255, 0.98);
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    overflow: hidden;
    display: none;
    flex-direction: column;
    z-index: 10001;
    width: 320px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    transition: all var(--transition-normal);
    animation: menuSlideIn 0.3s ease-out;
    backdrop-filter: blur(10px);
    transform: translateZ(0);
}

.dark-theme .menu-dropdown {
    background: rgba(40, 40, 40, 0.98);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

.menu-dropdown.show {
    display: flex;
}

.menu-item {
    padding: 18px 25px;
    font-size: 16px;
    font-weight: 500;
    color: #333;
    display: flex;
    align-items: center;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    cursor: pointer;
    transition: all var(--transition-fast);
    background: transparent;
    justify-content: space-between;
    position: relative;
    overflow: hidden;
}

.dark-theme .menu-item {
    color: #f0f0f0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.menu-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: all var(--transition-normal);
}

.menu-item:hover::before {
    left: 100%;
}

.menu-item:hover {
    background: rgba(150, 0, 24, 0.1);
    color: var(--primary-color);
    transform: translateX(5px);
}

.dark-theme .menu-item:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #ffffff;
}

.menu-item:hover i {
    transform: scale(1.2);
}

.menu-item span:first-child {
    display: flex;
    align-items: center;
}

/* Iconos específicos del menú */
#botonLogs i {
    color: #4caf50;
}

.dark-theme #botonLogs i { 
    color: #81c784; 
}

/* ✅ ICONOS ESPECÍFICOS EN MODO OSCURO (CONSOLIDADO) */
.dark-theme .fa-people-arrows { color: #ff6b6b !important; }
.dark-theme .fa-clipboard-list { color: #66bb6a !important; }
.dark-theme .fa-chart-bar { color: #42a5f5 !important; }
.dark-theme .fa-sync-alt { color: #ab47bc !important; }
.dark-theme .fa-volume-up { color: #ffa726 !important; }
.dark-theme .fa-adjust { color: #26c6da !important; }
.dark-theme .fa-expand { color: #ef5350 !important; }

/* =====================================================
   ESTILOS ESPECÍFICOS PARA EVACUACIÓN
   ===================================================== */

/* Ítem de evacuación con animación */
.evacuation-item {
    position: relative;
    background: linear-gradient(135deg, rgba(255, 152, 0, 0.15), rgba(244, 67, 54, 0.15)) !important;
    border-left: 4px solid var(--evacuation-color) !important;
    transition: all var(--transition-normal) !important;
    box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2) !important;
}

.evacuation-item:hover {
    background: linear-gradient(135deg, rgba(255, 152, 0, 0.25), rgba(244, 67, 54, 0.25)) !important;
    border-left-color: var(--evacuation-urgent) !important;
    box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4) !important;
    transform: translateX(8px) !important;
}

/* Ícono de evacuación con animación unificada */
.evacuation-icon {
    color: var(--evacuation-color) !important;
    font-size: 18px !important;
    margin-right: 12px !important;
    animation: pulseIntense 2s infinite !important;
    text-shadow: 0 0 4px rgba(255, 152, 0, 0.6) !important;
    filter: drop-shadow(0 0 2px rgba(255, 152, 0, 0.3)) !important;
}

/* Badge de emergencia */
.evacuation-badge {
    font-size: 18px !important;
    animation: pulse 1.2s infinite !important;
    margin-left: auto !important;
    filter: drop-shadow(0 0 3px rgba(255, 152, 0, 0.5)) !important;
}

/* Estado activo de evacuación */
.evacuation-item.active {
    background: linear-gradient(135deg, rgba(244, 67, 54, 0.3), rgba(198, 40, 40, 0.3)) !important;
    border-left-color: #d32f2f !important;
    box-shadow: 0 6px 16px rgba(244, 67, 54, 0.4) !important;
}

.evacuation-item.active .evacuation-icon {
    color: #d32f2f !important;
    animation: pulseIntense 1s infinite !important;
}

.dark-theme .evacuation-item {
    background: linear-gradient(135deg, rgba(255, 107, 107, 0.2), rgba(229, 57, 53, 0.2)) !important;
    border-left-color: var(--dark-evacuation-color) !important;
}

.dark-theme .evacuation-item:hover {
    background: linear-gradient(135deg, rgba(255, 107, 107, 0.3), rgba(229, 57, 53, 0.3)) !important;
    border-left-color: var(--dark-evacuation-urgent) !important;
}

.dark-theme .evacuation-icon {
    color: var(--dark-evacuation-color) !important;
    text-shadow: 0 0 3px rgba(255, 107, 107, 0.5) !important;
}

.dark-theme .evacuation-item.active .evacuation-icon {
    color: var(--dark-evacuation-urgent) !important;
}

/* =====================================================
   FORMULARIO PRINCIPAL
   ===================================================== */
#accessForm {
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 30px;
    margin-top: 20px;
    transition: all var(--transition-normal);
}

.input-container {
    position: relative;
    width: 100%;
    max-width: 900px;
    margin: 0 auto 30px auto;
    transition: all var(--transition-normal);
}

#cedula {
    width: 100%;
    padding: 20px 120px 20px 20px;
    font-size: clamp(24px, 4vw, 36px);
    border: none;
    border-radius: 25px;
    background: var(--theme-input-bg);
    backdrop-filter: blur(10px);
    color: var(--theme-text);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    transition: all var(--transition-normal);
    height: clamp(70px, 12vw, 100px);
    box-sizing: border-box;
    border: 2px solid transparent;
    position: relative;
}

#cedula:focus {
    outline: none;
    border-color: var(--secondary-color);
    background: rgba(255, 255, 255, 0.95);
    box-shadow: 0 15px 40px rgba(67, 160, 71, 0.2);
    transform: translateY(-2px);
}

#cedula::placeholder {
    color: rgba(0, 0, 0, 0.4);
    font-size: clamp(20px, 3.5vw, 32px);
}

.dark-theme #cedula {
    color: var(--dark-text-color); /* Asegura el color del texto en modo oscuro */
    background: var(--dark-input-bg); /* Asegura el color de fondo en modo oscuro */
}

.dark-theme #cedula::placeholder {
    color: rgba(255, 255, 255, 0.4);
}

/* Botones de acción del input */
.limpiar-cedula, .qr-button {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: all var(--transition-normal);
    backdrop-filter: blur(10px);
    font-weight: 600;
}

.limpiar-cedula {
    right: 80px;
    background: rgba(244, 67, 54, 0.1);
    color: #f44336;
    width: 50px;
    height: 50px;
    font-size: 20px;
    border: 1px solid rgba(244, 67, 54, 0.3);
    min-width: 50px;
}

.limpiar-cedula:hover {
    background: rgba(244, 67, 54, 0.2);
    color: #d32f2f;
    transform: translateY(-50%) scale(1.1);
    box-shadow: 0 5px 15px rgba(244, 67, 54, 0.3);
}

.qr-button {
    right: 15px;
    background: linear-gradient(135deg, rgba(76, 175, 80, 0.8), rgba(56, 142, 60, 0.8));
    color: white;
    width: 60px;
    height: 60px;
    font-size: 24px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
    min-width: 60px;
}

.qr-button:hover {
    background: linear-gradient(135deg, rgba(102, 187, 106, 0.9), rgba(76, 175, 80, 0.9));
    transform: translateY(-50%) scale(1.1) rotate(10deg);
    box-shadow: 0 12px 35px rgba(76, 175, 80, 0.4);
}

/* Sugerencias */
#cedulaSuggestions {
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    background: var(--theme-card-bg);
    backdrop-filter: blur(15px);
    border-radius: 15px;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
    list-style: none;
    padding: 0;
    margin: 10px 0 0 0;
    z-index: 10;
    display: none;
    transition: all var(--transition-normal);
    border: 1px solid var(--theme-border);
    max-height: 300px;
    overflow-y: auto;
    color: var(--theme-text);
}

.dark-theme #cedulaSuggestions {
    background: var(--dark-card-bg);
    color: var(--dark-text-color);
    border-color: var(--dark-border-color);
}

#cedulaSuggestions li {
    padding: 15px 20px;
    font-size: clamp(16px, 3vw, 24px);
    cursor: pointer;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all var(--transition-fast);
    position: relative;
    overflow: hidden;
}

.dark-theme #cedulaSuggestions li {
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

#cedulaSuggestions li::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(67, 160, 71, 0.1), transparent);
    transition: all var(--transition-normal);
}

#cedulaSuggestions li:hover::before {
    left: 100%;
}

#cedulaSuggestions li:hover {
    background: rgba(67, 160, 71, 0.05);
    transform: translateX(5px);
    border-left: 3px solid var(--secondary-color);
}

.dark-theme #cedulaSuggestions li:hover {
    background: rgba(67, 160, 71, 0.1);
}


/* Info seleccionada */
#infoSeleccionada {
    font-size: clamp(18px, 3.5vw, 28px);
    padding: 20px;
    margin: 15px 0;
    color: var(--theme-text);
    text-align: center;
    background: var(--theme-card-bg);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    box-shadow: 0 8px 25px var(--theme-shadow);
    transition: all var(--transition-normal);
    border: 1px solid var(--theme-border);
    position: relative;
    overflow: hidden;
}

.dark-theme #infoSeleccionada {
    background: var(--dark-card-bg);
    color: var(--dark-text-color);
    border-color: var(--dark-border-color);
}

#infoSeleccionada::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--secondary-color), var(--accent-color), var(--secondary-color));
    animation: infoShimmer 2s linear infinite;
}

.dark-theme #infoSeleccionada p,
.dark-theme #infoSeleccionada h3,
.dark-theme #infoSeleccionada div,
.dark-theme #infoSeleccionada strong {
    color: var(--dark-text-color); /* Asegura que el texto dentro sea legible */
}

/* =====================================================
   RADIO BUTTONS
   ===================================================== */
.radio-group {
    display: flex;
    justify-content: center;
    gap: clamp(30px, 8vw, 120px);
    margin: 40px 0;
    transition: all var(--transition-normal);
}

.radio-button {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: clamp(120px, 25vw, 180px);
    height: clamp(120px, 25vw, 180px);
    background: var(--theme-card-bg);
    backdrop-filter: blur(15px);
    padding: 20px;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    transition: all var(--transition-normal);
    box-shadow: 0 10px 30px var(--theme-shadow);
    border: 2px solid transparent;
    position: relative;
    overflow: hidden;
}

.dark-theme .radio-button {
    background: var(--dark-card-bg);
    border-color: var(--dark-border-color);
}

.radio-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    opacity: 0;
    transition: all var(--transition-normal);
}

.radio-button:hover::before {
    opacity: 1;
    animation: buttonShine 0.6s ease-out;
}

.radio-button:hover {
    transform: translateY(-8px) scale(1.05);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    border-color: rgba(67, 160, 71, 0.3);
}

.radio-button input[type="radio"] {
    display: none;
}

.radio-icon {
    font-size: clamp(40px, 10vw, 60px);
    color: var(--secondary-color);
    margin-bottom: 10px;
    transition: all var(--transition-normal);
    filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.1));
}

.dark-theme .radio-icon {
    color: var(--dark-secondary-color);
}

.radio-label {
    font-size: clamp(16px, 4vw, 24px);
    color: var(--theme-text);
    font-weight: 600;
    transition: all var(--transition-normal);
}

.dark-theme .radio-label {
    color: var(--dark-text-color);
}

.radio-button input[type="radio"]:checked + .radio-icon {
    color: var(--primary-color);
    transform: scale(1.2);
    animation: radioSelected 0.5s ease-out;
}

.radio-button input[type="radio"]:checked ~ .radio-label {
    color: var(--primary-color);
    font-weight: 700;
    transform: scale(1.05);
}

.dark-theme .radio-button input[type="radio"]:checked + .radio-icon,
.dark-theme .radio-button input[type="radio"]:checked ~ .radio-label {
    color: var(--dark-primary-color); /* Asegura el color en modo oscuro */
}

#radioError {
    color: var(--primary-color);
    text-align: center;
    font-size: clamp(18px, 3vw, 28px);
    margin-top: 10px;
    display: none;
    transition: all var(--transition-normal);
}

/* =====================================================
   BOTÓN DE ENVÍO
   ===================================================== */
input[type="submit"] {
    width: 100%;
    max-width: 600px;
    margin: 30px auto 0;
    padding: clamp(15px, 3vh, 25px);
    font-size: clamp(24px, 4vw, 40px);
    background: linear-gradient(135deg, var(--primary-color), #b71c1c);
    color: var(--light-color);
    border: none;
    border-radius: 25px;
    cursor: pointer;
    transition: all var(--transition-normal);
    box-shadow: 0 15px 35px rgba(150, 0, 24, 0.3);
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    position: relative;
    overflow: hidden;
}

input[type="submit"]:hover {
    background: linear-gradient(135deg, #c1001c, #8b0000);
    transform: translateY(-3px);
    box-shadow: 0 20px 45px rgba(150, 0, 24, 0.4);
}

input[type="submit"]:active {
    transform: translateY(-1px);
    box-shadow: 0 10px 25px rgba(150, 0, 24, 0.3);
}

/* =====================================================
   CIERRE Y COMENTARIOS
   ===================================================== */
#cierreComentario {
    display: none;
    margin-top: 30px;
    padding: 20px;
    background: var(--theme-card-bg);
    backdrop-filter: blur(15px);
    border-radius: 20px;
    box-shadow: 0 10px 30px var(--theme-shadow);
    transition: all var(--transition-normal);
    border: 1px solid var(--theme-border);
}

.dark-theme #cierreComentario {
    background: var(--dark-card-bg);
    border-color: var(--dark-border-color);
}

#comentarioCierre {
    width: 100%;
    padding: 15px;
    font-size: clamp(18px, 3vw, 24px);
    border: 2px solid #ddd;
    border-radius: 15px;
    margin-bottom: 15px;
    resize: none;
    box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all var(--transition-normal);
    background: var(--theme-input-bg);
    color: var(--theme-text);
}

.dark-theme #comentarioCierre {
    border-color: #666;
    background: var(--dark-input-bg);
    color: var(--dark-text-color);
}

#comentarioCierre:focus {
    border-color: var(--secondary-color);
    box-shadow: 0 0 10px rgba(67, 160, 71, 0.3);
    outline: none;
}

#botonComentario {
    display: block;
    width: 100%;
    padding: 15px;
    background: linear-gradient(135deg, var(--primary-color), #b71c1c);
    color: var(--light-color);
    border: none;
    border-radius: 15px;
    font-size: clamp(18px, 3vw, 24px);
    cursor: pointer;
    transition: all var(--transition-normal);
    box-shadow: 0 8px 20px rgba(150, 0, 24, 0.3);
    font-weight: 600;
    letter-spacing: 0.5px;
}

#botonComentario:hover {
    background: linear-gradient(135deg, #c1001c, #940016);
    transform: translateY(-2px);
    box-shadow: 0 12px 25px rgba(150, 0, 24, 0.4);
}

/* =====================================================
   NOTIFICACIONES
   ===================================================== */
#notification {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 500px;
    background: var(--theme-card-bg);
    backdrop-filter: blur(15px);
    padding: 20px;
    border-radius: 20px;
    box-shadow: 0 15px 35px var(--theme-shadow);
    z-index: 1000;
    display: none;
    text-align: center;
    font-size: clamp(16px, 3vw, 24px);
    transition: all var(--transition-normal);
    border: 1px solid var(--theme-border);
    animation: notificationSlideUp 0.4s ease-out;
    color: var(--theme-text);
}

/* =====================================================
   VISTAS PREVIAS Y MODALES
   ===================================================== */
#vistaPrevia,
#vistaPreviaHistorial {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    z-index: 1000;
    overflow-y: auto;
    transition: all var(--transition-normal);
    display: none;
}

.dark-theme #vistaPrevia,
.dark-theme #vistaPreviaHistorial {
    background: rgba(30, 30, 30, 0.98) !important;
    color: var(--dark-text-color) !important; /* Asegura el color del texto */
    border: 1px solid #444 !important;
}

#contenidoVistaPrevia,
#vistaPreviaHistorialContenido {
    background-color: var(--theme-card-bg);
    color: var(--theme-text);
    margin: 30px;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    position: relative;
    max-width: calc(100% - 60px);
    margin-left: auto;
    margin-right: auto;
    transition: all var(--transition-normal);
}

.dark-theme #contenidoVistaPrevia,
.dark-theme #vistaPreviaHistorialContenido {
    background-color: var(--dark-card-bg);
    color: var(--dark-text-color);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
}

.btn-regresar {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(244, 67, 54, 0.1);
    color: #f44336;
    border: none;
    font-size: 40px;
    cursor: pointer;
    z-index: 10;
    transition: all var(--transition-normal);
    width: 60px;
    height: 60px;
    display: flex;
    justify-content: center;
    align-items: center;
    border-radius: 50%;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(10px);
}

.btn-regresar:hover {
    transform: scale(1.1);
    color: #d32f2f;
    background: rgba(244, 67, 54, 0.2);
    box-shadow: 0 8px 20px rgba(244, 67, 54, 0.3);
}

/* Modal de Logs */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background: var(--theme-card-bg);
    color: var(--theme-text);
    border-radius: 10px;
    width: 90%;
    max-width: 800px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
}

.dark-theme .modal-content {
    background: var(--dark-card-bg);
    color: var(--dark-text-color);
}

.modal-header {
    padding: 15px 20px;
    background: var(--primary-color);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.dark-theme .modal-header {
    background: #1a1a2e;
}

.modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
}

.close-button {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.close-button:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

.log-content {
    padding: 20px;
    overflow-y: auto;
    flex-grow: 1;
    font-family: monospace;
    font-size: 0.9rem;
    line-height: 1.5;
}

.dark-theme .log-content {
    background: #1e2a3a;
    color: #e0e0e0;
}

.log-content p {
    margin: 0 0 10px 0;
    padding: 5px 0;
    border-bottom: 1px solid #eee;
}

.dark-theme .log-content p {
    border-bottom-color: #3a4a5f;
}

.log-content .info {
    color: #2196F3;
}

.log-content .warn {
    color: #FFC107;
}

.log-content .error {
    color: #F44336;
}

/* =====================================================
   ESCÁNER QR
   ===================================================== */
#qrScanner {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(5px);
    z-index: 2000;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 20px;
    transition: all var(--transition-normal);
}

#html5-qrcode-anchor-scan-type-change {
    color: white !important;
    font-size: 18px !important;
    margin-bottom: 10px !important;
}

#html5-qrcode-button-camera-permission {
    padding: 15px 25px !important;
    font-size: 20px !important;
    background-color: #43a047 !important;
    color: white !important;
    border: none !important;
    border-radius: 10px !important;
    cursor: pointer !important;
    margin: 10px auto !important;
    display: block !important;
}

#qr-reader {
    max-width: 100%;
    width: 400px !important;
    border: 4px solid white !important;
    border-radius: 20px !important;
    overflow: hidden !important;
    box-shadow: 0 0 30px rgba(255, 255, 255, 0.2) !important;
}

#qr-reader__dashboard {
    background: #333 !important;
    padding: 15px !important;
}

#qr-reader__dashboard button {
    padding: 12px 20px !important;
    font-size: 18px !important;
    color: white !important;
    background: #43a047 !important;
    border: none !important;
    border-radius: 8px !important;
    margin: 5px !important;
    cursor: pointer !important;
}

#qr-reader__dashboard select {
    padding: 10px !important;
    font-size: 16px !important;
    margin: 5px !important;
    border-radius: 5px !important;
    background: #f0f0f0 !important;
    border: none !important;
}

.qr-info {
    color: var(--light-color);
    margin-top: 20px;
    font-size: clamp(18px, 3vw, 24px);
    text-align: center;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    max-width: 80%;
    transition: all var(--transition-normal);
    font-weight: 500;
}

.qr-close-button {
    margin-top: 20px;
    padding: 15px 30px;
    background: linear-gradient(135deg, #f44336, #d32f2f);
    color: var(--light-color);
    border: none;
    border-radius: 25px;
    font-size: clamp(18px, 3vw, 24px);
    cursor: pointer;
    transition: all var(--transition-normal);
    box-shadow: 0 10px 25px rgba(244, 67, 54, 0.4);
    font-weight: 600;
    letter-spacing: 0.5px;
}

.qr-close-button:hover {
    background: linear-gradient(135deg, #ff5252, #f44336);
    transform: translateY(-3px);
    box-shadow: 0 15px 35px rgba(244, 67, 54, 0.5);
}

#qrVideo {
    width: 300px;
    height: 300px;
    border-radius: 15px;
    transition: all var(--transition-normal);
}

#qrCanvas {
    display: none;
    transition: all var(--transition-normal);
}

/* =====================================================
   LOADING OVERLAY
   ===================================================== */
#loadingOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(5px);
    display: none;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    z-index: 3000;
    transition: all var(--transition-normal);
}

.spinner {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 6px solid rgba(255, 255, 255, 0.1);
    border-top-color: var(--secondary-color);
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
    box-shadow: 0 0 30px rgba(67, 160, 71, 0.3);
}

#loadingOverlay p {
    color: var(--light-color);
    font-size: clamp(18px, 4vw, 28px);
    text-align: center;
    font-weight: 600;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    animation: loadingPulse 2s ease-in-out infinite;
}

/* =====================================================
   PANEL DE ESTADÍSTICAS
   ===================================================== */
#statsPanel {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: var(--theme-card-bg);
    backdrop-filter: blur(15px);
    padding: 15px;
    border-radius: 15px;
    box-shadow: 0 10px 30px var(--theme-shadow);
    transition: all var(--transition-normal);
    cursor: default;
    user-select: none;
    z-index: 150;
    overflow: hidden;
    border: 1px solid var(--theme-border);
    max-width: 300px;
    color: var(--theme-text);
}

.dark-theme #statsPanel {
    background: var(--dark-card-bg);
    border-color: var(--dark-border-color);
    color: var(--dark-text-color);
}

.stats-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--theme-border);
    cursor: move;
    touch-action: none;
}

.dark-theme .stats-panel-header {
    border-color: var(--dark-border-color);
}

.stats-panel-header h3 {
    font-size: 16px;
    margin: 0;
    color: var(--primary-color);
    font-weight: 600;
}

.dark-theme .stats-panel-header h3 {
    color: var(--dark-primary-color);
}

.stats-panel-content {
    transition: all var(--transition-normal);
}

.stats-panel-toggle {
    cursor: pointer;
    background: none;
    border: none;
    color: inherit;
    font-size: 16px;
    padding: 4px;
    border-radius: 50%;
    transition: all var(--transition-fast);
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.stats-panel-toggle:hover {
    background: rgba(0, 0, 0, 0.1);
    transform: scale(1.1);
}

.dark-theme .stats-panel-toggle {
    color: var(--dark-text-color);
}

#statsPanel.minimized {
    height: auto;
    overflow-y: hidden;
}

#statsPanel.minimized .stats-panel-content {
    display: none;
}

#entradasLive,
#salidasLive {
    font-size: 20px;
    font-weight: 600;
    margin: 5px 0;
    transition: all var(--transition-normal);
}

#entradasLive {
    color: var(--success-color);
}

#salidasLive {
    color: var(--warning-color);
}

#entradasLive span,
#salidasLive span {
    transition: all var(--transition-normal);
}

#miniChart {
    width: 200px;
    height: 100px;
    margin: 10px 0;
    transition: all var(--transition-normal);
}

#liveHistory {
    margin-top: 15px;
    max-height: 200px;
    overflow-y: auto;
    transition: all var(--transition-normal);
}

#liveHistory h4 {
    font-size: 14px;
    margin-bottom: 8px;
    color: var(--primary-color);
    font-weight: 600;
}

.dark-theme #liveHistory h4 {
    color: var(--dark-primary-color);
}

#liveHistory table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    transition: all var(--transition-normal);
}

#liveHistory table th,
#liveHistory table td {
    padding: 4px;
    text-align: left;
    transition: all var(--transition-normal);
    color: var(--theme-text);
}

.dark-theme #liveHistory table th,
.dark-theme #liveHistory table td {
    color: var(--dark-text-color);
}

#liveHistory table thead tr {
    background: rgba(0, 0, 0, 0.05);
    transition: all var(--transition-normal);
}

.dark-theme #liveHistory table thead tr {
    background: rgba(255, 255, 255, 0.1);
}

/* =====================================================
   ESTILOS MODERNOS PARA EVACUACIÓN
   ===================================================== */

/* Animaciones modernas */
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

@keyframes slideIn {
    from { transform: translateY(-20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* Botones modernos de tipo de evacuación */
.type-card-modern {
    position: relative;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 2px solid #e5e7eb;
    background: white;
    cursor: pointer;
}

.type-card-modern:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
    border-color: #3b82f6;
}

.type-card-modern.selected {
    border-color: #2563eb;
    background: linear-gradient(135deg, #eff6ff, #dbeafe);
    transform: translateY(-2px);
}

.type-card-modern.simulacro.selected {
    border-color: #7c3aed;
    background: linear-gradient(135deg, #f3e8ff, #e9d5ff);
}

.type-card-modern.real.selected {
    border-color: #dc2626;
    background: linear-gradient(135deg, #fef2f2, #fee2e2);
}

/* Tarjetas de personal modernas */
.person-card-modern {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 16px;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.person-card-modern:hover {
    border-color: #3b82f6;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
}

.person-card-modern.selected {
    border-color: #10b981;
    background: linear-gradient(135deg, #f0fdf4, #ecfdf5);
    transform: translateY(-2px);
}

.person-card-modern input[type="checkbox"] {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 20px;
    height: 20px;
    accent-color: #10b981;
    cursor: pointer;
}

.person-info {
    margin-right: 30px;
}

.person-name {
    font-weight: 600;
    color: #1f2937;
    font-size: 1.1rem;
    margin-bottom: 4px;
}

.person-details {
    color: #6b7280;
    font-size: 0.875rem;
    line-height: 1.4;
}

.person-status {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
    margin-top: 8px;
}

.status-active {
    background: #d1fae5;
    color: #065f46;
}

/* Información de tipo seleccionado */
.info-tipo-seleccionado {
    padding: 16px;
    border-radius: 8px;
    margin-top: 16px;
}

.info-simulacro {
    background: linear-gradient(135deg, #f3e8ff, #e9d5ff);
    border-left: 4px solid #7c3aed;
    color: #581c87;
}

.info-real {
    background: linear-gradient(135deg, #fef2f2, #fee2e2);
    border-left: 4px solid #dc2626;
    color: #7f1d1d;
}

/* Estados de carga modernos */
.loading-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 16px;
}

.loading-card {
    background: #f9fafb;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 16px;
    animation: pulse 2s infinite;
}

.loading-skeleton {
    background: #e5e7eb;
    border-radius: 4px;
    height: 16px;
    margin-bottom: 8px;
}

.loading-skeleton.wide {
    width: 100%;
}

.loading-skeleton.medium {
    width: 70%;
}

.loading-skeleton.short {
    width: 40%;
}

/* Tema oscuro para estilos modernos */
.dark-theme .type-card-modern {
    background: #374151;
    border-color: #4b5563;
    color: #e5e7eb;
}

.dark-theme .type-card-modern:hover {
    border-color: #60a5fa;
}

.dark-theme .type-card-modern.selected {
    background: linear-gradient(135deg, #1e3a8a, #1e40af);
    border-color: #3b82f6;
}

.dark-theme .person-card-modern {
    background: #374151;
    border-color: #4b5563;
}

.dark-theme .person-card-modern:hover {
    border-color: #60a5fa;
}

.dark-theme .person-card-modern.selected {
    background: linear-gradient(135deg, #064e3b, #065f46);
    border-color: #10b981;
}

.dark-theme .person-name {
    color: #e5e7eb;
}

.dark-theme .person-details {
    color: #9ca3af;
}

.dark-theme .loading-card {
    background: #374151;
    border-color: #4b5563;
}

.dark-theme .loading-skeleton {
    background: #4b5563;
}

/* =====================================================
   MODAL DE EVACUACIÓN COMPLETO Y MEJORADO
   ===================================================== */
#evacuationModal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(8px);
    z-index: 2000;
    display: none;
    justify-content: center;
    align-items: center;
    padding: 20px;
    transition: all var(--transition-normal);
}

#evacuationModal.show {
    display: flex;
    animation: modalSlideIn 0.4s ease-out;
}

#evacuationModalContent {
    background: linear-gradient(135deg, #ffffff, #f8f9fa);
    border-radius: 20px;
    max-width: 800px;
    width: 95%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
    border: 3px solid var(--evacuation-color);
    position: relative;
    animation: contentSlideUp 0.5s ease-out;
}

.dark-theme #evacuationModalContent {
    background: var(--dark-card-bg);
    color: var(--dark-text-color);
    border: 1px solid var(--dark-border-color);
    border-color: var(--dark-evacuation-color);
}

/* Header del modal de evacuación */
.evacuation-header {
    background: linear-gradient(135deg, var(--evacuation-color), #f57c00);
    color: white;
    padding: 25px;
    border-radius: 17px 17px 0 0;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.dark-theme .evacuation-header {
    background: linear-gradient(135deg, #d32f2f, #b71c1c);
}

.evacuation-header::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 10px,
        rgba(255,255,255,0.1) 10px,
        rgba(255,255,255,0.1) 20px
    );
    animation: stripesMove 3s linear infinite;
}

.evacuation-header h3 {
    font-size: 28px;
    margin: 0;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    position: relative;
    z-index: 1;
}

.dark-theme #evacuationModalContent h3 {
    color: #ffffff !important;
}

.evacuation-status {
    font-size: 48px;
    margin: 15px 0;
    position: relative;
    z-index: 1;
}

/* Lista de personas mejorada */
#listaPersonasDentro {
    padding: 20px;
    max-height: 400px;
    overflow-y: auto;
    list-style: none;
    margin: 0;
    background: transparent;
}

#listaPersonasDentro li {
    display: flex;
    align-items: center;
    padding: 15px;
    margin-bottom: 10px;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(248, 249, 250, 0.8));
    border-radius: 12px;
    border-left: 4px solid var(--evacuation-color);
    transition: all var(--transition-normal);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    color: var(--theme-text);
}

.dark-theme #listaPersonasDentro li {
    background: rgba(255, 255, 255, 0.05);
    border-bottom: 1px solid var(--dark-border-color);
    color: var(--dark-text-color) !important;
    margin-bottom: 5px;
    border-radius: 8px;
    border-left-color: var(--dark-evacuation-color);
}

#listaPersonasDentro li:hover {
    background: linear-gradient(135deg, rgba(255, 152, 0, 0.1), rgba(255, 193, 7, 0.1));
    border-left-color: var(--evacuation-urgent);
    transform: translateX(5px);
    box-shadow: 0 4px 12px rgba(255, 152, 0, 0.2);
}

.dark-theme #listaPersonasDentro li:hover {
    background: rgba(255, 255, 255, 0.1);
    border-left-color: var(--dark-evacuation-urgent);
}

#listaPersonasDentro li.selected {
    background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(102, 187, 106, 0.2));
    border-left-color: #4caf50;
}

#listaPersonasDentro li input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin-right: 15px;
    cursor: pointer;
    accent-color: var(--evacuation-color);
    transform: scale(1.2);
}

.dark-theme #listaPersonasDentro li input[type="checkbox"] {
    filter: brightness(1.2);
    accent-color: var(--dark-evacuation-color);
}

#listaPersonasDentro li label {
    flex-grow: 1;
    cursor: pointer;
    font-weight: 500;
    color: #333;
}

.dark-theme #listaPersonasDentro li label {
    color: var(--dark-text-color) !important;
    font-weight: 500;
}

/* Botones de acción mejorados */
.evacuation-actions {
    padding: 20px;
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 0 0 17px 17px;
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    justify-content: center;
}

.dark-theme .evacuation-actions {
    background: linear-gradient(135deg, #333333, #2a2a2a);
}

.dark-theme #evacuationModalContent .btn-regresar {
    color: #ffffff;
    background-color: #3d3d3d;
    border: 1px solid #555555;
}

.dark-theme #evacuationModalContent .btn-regresar:hover {
    background-color: #555555;
    color: #ffffff;
}

/* Indicador de estado en tiempo real */
.evacuation-status-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, var(--evacuation-color), #f57c00);
    color: white;
    padding: 10px 15px;
    border-radius: 25px;
    font-size: 14px;
    font-weight: bold;
    z-index: 3000;
    box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
    animation: statusPulse 2s infinite;
    display: none;
}

.evacuation-status-indicator.active {
    display: block;
}

/* Loading mejorado para evacuación */
.evacuation-loading {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(5px);
    display: none;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    z-index: 4000;
}

.evacuation-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid rgba(255, 152, 0, 0.2);
    border-top: 4px solid var(--evacuation-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
}

.evacuation-loading p {
    color: white;
    font-size: 18px;
    font-weight: 500;
    margin: 0;
}

/* =====================================================
   BOTONES Y ELEMENTOS ESPECIALES
   ===================================================== */
#limpiarHistorialCentral {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1000;
    padding: 20px 40px;
    font-size: clamp(24px, 4vw, 36px);
    background: linear-gradient(135deg, #f44336, #d32f2f);
    color: white;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    box-shadow: 0 15px 40px rgba(244, 67, 54, 0.4);
    animation: pulseIntense 2s infinite;
    display: none;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.2);
}

.limpiar-central:hover {
    background: linear-gradient(135deg, #ff5252, #f44336);
    transform: translate(-50%, -50%) scale(1.1);
    animation: none;
}

.dark-theme .limpiar-central {
    background: linear-gradient(135deg, #d32f2f, #b71c1c);
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.7);
}

.limpiar-central i {
    margin-right: 10px;
    font-size: inherit;
}

#lastRecord {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    text-align: center;
    padding-top: 20%;
    z-index: 1000;
    transition: all var(--transition-normal);
}

#lastCedula,
#lastAction,
#lastTime {
    font-size: clamp(24px, 5vw, 48px);
    margin: 10px 0;
    transition: all var(--transition-normal);
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
}

#lastRecord.show {
    animation: fadeIn 1s ease;
}

#botonLimpiar {
    display: none;
    color: #e53935;
}

.no-hover {
    transition: none !important;
    transform: none !important;
    box-shadow: none !important;
}

.no-hover:hover {
    background-color: initial !important;
    border-color: initial !important;
    color: initial !important;
    cursor: default;
}

/* Switch toggle */
.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 28px;
    margin-left: 10px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: all 0.4s ease;
    border-radius: 28px;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

.dark-theme .slider {
    background-color: #666;
}

.slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: all 0.4s ease;
    border-radius: 50%;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}

input:checked + .slider {
    background-color: var(--secondary-color);
    box-shadow: inset 0 2px 4px rgba(67, 160, 71, 0.2);
}

.dark-theme input:checked + .slider {
    background-color: var(--dark-secondary-color);
}

input:checked + .slider:before {
    transform: translateX(22px);
}

/* =====================================================
   TABLAS Y ELEMENTOS ADICIONALES
   ===================================================== */

/* Tablas en tema oscuro */
.dark-theme table { 
    border-color: #555; 
}

.dark-theme th {
    background-color: #444 !important;
    color: var(--dark-text-color) !important;
    border-color: #555 !important;
}

.dark-theme td {
    border-color: #555 !important;
    color: var(--dark-text-color) !important;
}

.dark-theme tr:nth-child(even) {
    background-color: rgba(80, 80, 80, 0.3);
}

/* Colores de notificación */
.notification-success {
    background: linear-gradient(135deg, #4caf50, #388e3c) !important;
}

.notification-error {
    background: linear-gradient(135deg, #f44336, #d32f2f) !important;
}

.notification-warning {
    background: linear-gradient(135deg, #ff9800, #f57c00) !important;
}

.notification-info {
    background: linear-gradient(135deg, #2196f3, #1976d2) !important;
}

/* Preview table styles */
.preview-table th {
    background: linear-gradient(135deg, var(--primary-color), #b71c1c);
    color: white;
    border-color: #ddd;
}

.dark-theme .preview-table th {
    background: linear-gradient(135deg, var(--dark-primary-color), #1a1a1a) !important;
    color: var(--dark-text-color) !important;
    border-color: #555 !important;
}

.dark-theme .preview-table td {
    border-color: #555 !important;
    color: var(--dark-text-color) !important;
}

.dark-theme .preview-table tr:nth-child(even) {
    background-color: rgba(80, 80, 80, 0.3) !important;
}

/* =====================================================
   RESPONSIVE DESIGN
   ===================================================== */
@media (max-width: 768px) {
    .header {
        padding: 30px 0;
    }

    .menu-button {
        width: 50px;
        height: 50px;
        font-size: 20px;
        top: 15px;
        right: 15px;
        min-width: 50px;
    }

    .menu-dropdown {
        width: 250px;
        top: 70px;
        right: 15px;
    }

    .menu-item {
        padding: 12px 16px;
        font-size: 14px;
    }

    .input-container {
        max-width: 100%;
    }

    #cedula {
        padding: 15px 100px 15px 15px;
        height: clamp(60px, 10vw, 80px);
    }

    .qr-button {
        right: 10px;
        width: 50px;
        height: 50px;
        font-size: 20px;
        min-width: 50px;
    }

    .radio-group {
        gap: 20px;
    }

    .conexion-indicador {
        font-size: 14px;
        padding: 6px 12px;
    }

    #statsPanel {
        width: 90%;
        max-width: 280px;
    }

    #evacuationModalContent {
        width: 100%;
        margin: 10px;
        max-height: 95vh;
        padding: 20px;
    }

    .evacuation-header h3 {
        font-size: 22px;
    }

    .evacuation-status {
        font-size: 36px;
    }

    .evacuation-actions {
        flex-direction: column;
    }

    #listaPersonasDentro {
        padding: 15px;
        max-height: 300px;
    }

    #listaPersonasDentro li {
        font-size: 16px;
    }

    #listaPersonasDentro li input[type="checkbox"] {
        width: 18px;
        height: 18px;
    }
}

@media (max-width: 480px) {
    .radio-group {
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }

    .radio-button {
        width: 200px;
        height: 80px;
        flex-direction: row;
        gap: 10px;
    }

    .radio-icon {
        margin-bottom: 0;
        font-size: clamp(24px, 6vw, 36px);
    }

    .radio-label {
        font-size: clamp(14px, 3vw, 18px);
    }

    #cedulaSuggestions li {
        font-size: clamp(14px, 3vw, 18px);
        padding: 12px 16px;
    }

    #infoSeleccionada {
        font-size: clamp(16px, 3vw, 20px);
    }

    .menu-dropdown {
        width: calc(100vw - 30px);
        right: 15px;
    }

    #statsPanel {
        bottom: 10px;
        left: 10px;
        right: 10px;
        width: calc(100% - 20px);
        max-width: none;
    }
}

/* =====================================================
   UTILIDADES Y ESTADOS
   ===================================================== */
@media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

button:focus-visible,
input:focus-visible {
    outline: 2px solid var(--secondary-color);
    outline-offset: 2px;
}

.fade-in {
    animation: fadeIn 0.5s ease-in;
}

.slide-up {
    animation: slideIn 0.4s ease-out;
}

.bounce {
    animation: bounce 0.6s ease;
}

.glow {
    animation: glow 2s ease-in-out infinite alternate;
}

.shake {
    animation: shake 0.5s ease-in-out;
}

/* =====================================================
   ESTILOS PARA IMPRESIÓN
   ===================================================== */
@media print {
    body { background: white !important; }
    .action-buttons, .loading { display: none !important; }
    .container { box-shadow: none !important; }
    .header { background: #f5f5f5 !important; color: black !important; }
    .btn, input[type="checkbox"] { display: none !important; }
    .table th { background: #f0f0f0 !important; }
}

/* ✅ NUEVOS ESTILOS PARA MODALES PERSONALIZADOS */
.custom-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(5px);
    z-index: 5000; /* Mayor que otros modales */
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
}

.custom-modal-overlay.show {
    opacity: 1;
    visibility: visible;
}

.custom-modal-content {
    background: var(--theme-card-bg);
    color: var(--theme-text);
    border-radius: 20px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 25px 50px rgba(0,0,0,0.3);
    overflow: hidden;
    animation: modalSlideIn 0.4s ease-out;
    border: 1px solid var(--theme-border);
}

.dark-theme .custom-modal-content {
    background: var(--dark-card-bg);
    border-color: var(--dark-border-color);
    color: var(--dark-text-color); /* Asegura el color del texto en el modal */
}

.custom-modal-header {
    padding: 20px;
    background: linear-gradient(135deg, var(--primary-color), var(--error-color));
    color: white;
    text-align: center;
    position: relative;
    border-radius: 20px 20px 0 0;
}

.dark-theme .custom-modal-header {
    background: linear-gradient(135deg, var(--dark-primary-color), var(--dark-evacuation-urgent));
}

.custom-modal-header h3 {
    margin: 0;
    font-size: 24px;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
}

.custom-modal-body {
    padding: 30px;
    text-align: center;
}

.custom-modal-body p {
    font-size: 18px;
    margin-bottom: 25px;
    line-height: 1.6;
    color: var(--theme-text); /* Asegura el color del texto en el body del modal */
}

.dark-theme .custom-modal-body p {
    color: var(--dark-text-color);
}

.custom-modal-buttons {
    display: flex;
    justify-content: center;
    gap: 15px;
    padding: 0 30px 30px;
}

.custom-modal-buttons .btn-base {
    flex-grow: 1;
    padding: 12px 20px;
    font-size: 16px;
    border-radius: 10px;
}

/* Estilos para el modal de notificaciones general */
#customNotificationModal .custom-modal-content {
    max-width: 450px;
}

#customNotificationModal .custom-modal-header {
    background: linear-gradient(135deg, var(--info-color), #1976d2); /* Default blue for info */
}

#customNotificationModal .custom-modal-header.success {
    background: linear-gradient(135deg, var(--success-color), #388e3c);
}
#customNotificationModal .custom-modal-header.error {
    background: linear-gradient(135deg, var(--error-color), #d32f2f);
}
#customNotificationModal .custom-modal-header.warning {
    background: linear-gradient(135deg, var(--warning-color), #f57c00);
}
#customNotificationModal .custom-modal-header.orange { /* Specific for orange */
    background: linear-gradient(135deg, #ff9800, #f57c00);
}

#customNotificationModal .custom-modal-header i {
    font-size: 48px;
    margin-bottom: 10px;
    display: block;
}

#customNotificationModal .custom-modal-body p {
    white-space: pre-wrap; /* Para respetar saltos de línea \n */
}

    </style>
</head>

<body>
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p>Procesando...</p>
    </div>

    <div class="container">
        <div id="conexionIndicador" class="conexion-indicador online">
            <i class="fas fa-wifi"></i>
            <span class="conexion-texto">En línea</span>
        </div>

        <div class="header">
            <h1>SurPass</h1>
            <button id="menuButton" class="menu-button" aria-label="Menú">
                <i class="fas fa-bars"></i>
            </button>
            <div id="menuDropdown" class="menu-dropdown">
                <div id="botonLimpiar" class="menu-item">
                    <span><i class="fas fa-trash-alt"></i> Limpiar</span>
                </div>
                <div id="botonFinalizar" class="menu-item">
                    <span><i class="fas fa-check-circle"></i> Finalizar</span>
                </div>
                <div id="botonInfo" class="menu-item">
                    <span><i class="fas fa-info-circle"></i> Información</span>
                </div>
                <div id="botonHistorial" class="menu-item">
                    <span><i class="fas fa-history"></i> Historial</span>
                </div>
                <!-- BOTÓN DE EVACUACIÓN CORREGIDO -->
                <div id="botonEvacuacion" class="menu-item evacuation-item">
                    <span>
                        <i class="fas fa-people-arrows evacuation-icon"></i> 
                        <strong>Modo Evacuación</strong>
                    </span>
                    <span class="evacuation-badge">🚨</span>
                </div>
                <div id="botonToggleEstadisticas" class="menu-item">
                    <span><i class="fas fa-chart-bar"></i> Panel Estadísticas</span>
                    <label class="switch">
                        <input type="checkbox" id="toggleStats" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div id="botonCambiarEscaner" class="menu-item">
                    <span><i class="fas fa-sync-alt"></i> Escaner Nativo</span>
                    <label class="switch">
                        <input type="checkbox" id="toggleScanner">
                        <span class="slider"></span>
                    </label>
                </div>
                <div id="botonToggleSonidos" class="menu-item">
                    <span><i class="fas fa-volume-up"></i> Sonidos</span>
                    <label class="switch">
                        <input type="checkbox" id="toggleSounds" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div id="botonTema" class="menu-item">
                    <span><i class="fas fa-adjust"></i> Cambiar Tema</span>
                </div>
                <div id="fullscreenToggle" class="menu-item">
                    <span><i class="fas fa-expand"></i> Pantalla Completa</span>
                </div>
                <div id="botonLogs" class="menu-item">
                    <span><i class="fas fa-clipboard-list"></i> Logs</span>
                </div>
            </div>
        </div>

        <form id="accessForm">
            <div class="input-container">
                <input type="text" id="cedula" placeholder="Ingrese cédula o nombre" autocomplete="off" aria-label="Ingrese cédula o nombre">
                <button type="button" id="limpiarCedula" class="limpiar-cedula" aria-label="Limpiar campo" style="display: none;">
                    <i class="fas fa-times-circle"></i>
                </button>
                <button type="button" id="qrButton" class="qr-button" aria-label="Escanear código QR">
                    <i class="fas fa-qrcode"></i>
                </button>
                <ul id="cedulaSuggestions" class="suggestions"></ul>
            </div>

            <div id="infoSeleccionada"></div>

            <div class="radio-group">
                <label class="radio-button">
                    <input type="radio" name="respuesta" value="entrada" required>
                    <span class="radio-icon"><i class="fas fa-sign-in-alt"></i></span>
                    <span class="radio-label">Entrada</span>
                </label>
                <label class="radio-button">
                    <input type="radio" name="respuesta" value="salida" required>
                    <span class="radio-icon"><i class="fas fa-sign-out-alt"></i></span>
                    <span class="radio-label">Salida</span>
                </label>
            </div>
            <div id="radioError">Por favor, seleccione entrada o salida</div>

            <input type="submit" value="Registrar">
        </form>

        <div id="cierreComentario">
            <input type="text" id="comentarioCierre" placeholder="Causa del acceso denegado">
            <button id="botonComentario">Enviar Comentario</button>
        </div>
    </div>

    <!-- NOTIFICACIÓN ANTIGUA - SE MANTIENE PERO NO SE USA DIRECTAMENTE -->
    <div id="notification" class="notification"></div>

    <button id="limpiarHistorialCentral" class="limpiar-central">
        <i class="fas fa-trash-alt"></i> Limpiar Historial
    </button>

    <!-- Log Overlay -->
    <div id="logOverlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Registro de Actividades</h2>
                <button id="closeLogOverlay" class="close-button">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="logContent" class="log-content">
                <!-- Logs will be displayed here -->
            </div>
        </div>
    </div>

    <div id="vistaPrevia">
        <div id="contenidoVistaPrevia"></div>
        <button class="btn-regresar" onclick="cerrarVistaPrevia()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <div id="vistaPreviaHistorial">
        <div id="vistaPreviaHistorialContenido"></div>
        <button class="btn-regresar" onclick="cerrarVistaPreviaHistorial()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <div id="qrScanner">
        <div id="qr-reader"></div>
        <div class="qr-info">Escaneando documento... Apunte la cámara al código QR o documento de identidad</div>
        <div id="qrModalContent" style="display:none;"> <!-- Ocultar si html5-qrcode se encarga -->
            <video id="qrVideo" width="300" height="300" autoplay></video>
            <canvas id="qrCanvas" style="display: none;"></canvas>
            <button onclick="cerrarQrModal()" class="boton-cerrar-qr">Cerrar</button>
        </div>
        <button id="qrCloseButton" class="qr-close-button">Cancelar</button>
    </div>

    <!-- Antiguo logOverlay, el de arriba es el correcto -->
    <div id="logOverlay" class="log-overlay" style="display:none;"> <!-- Ocultar este duplicado -->
        <div id="logContent" class="log-content"></div>
        <button id="logCloseButton" class="log-close-button">Cerrar</button>
    </div>

    <div id="statsPanel">
        <div class="stats-panel-header">
            <h3>Estadísticas en Tiempo Real</h3>
            <button class="stats-panel-toggle" title="Minimizar/Maximizar panel">
                <i class="fas fa-minus"></i>
            </button>
        </div>
        <div class="stats-panel-content">
            <div id="entradasLive">Entradas: <span>0</span></div>
            <div id="salidasLive">Salidas: <span>0</span></div>
            <div id="miniChart"></div>
            <div id="liveHistory">
                <h4>Últimos Registros</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Cédula</th>
                            <th>Acción</th>
                            <th>Hora</th>
                        </tr>
                    </thead>
                    <tbody id="liveHistoryBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="lastRecord">
        <h2>Último Registro</h2>
        <p id="lastCedula"></p>
        <p id="lastAction"></p>
        <p id="lastTime"></p>
    </div>

    <audio id="successSound" src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_0625c1539c.mp3?filename=success-1-6297.mp3" preload="auto"></audio>
    <audio id="errorSound" src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_c8c8a73f4b.mp3?filename=error-126627.mp3" preload="auto"></audio>
    <audio id="scanSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_c8a38ca50c.mp3?filename=beep-6-96243.mp3" preload="auto"></audio>

    <!-- ✅ MODAL MODERNO DE EVACUACIÓN MEJORADO ✅ -->
    <div id="evacuationModal" class="custom-modal-overlay">
        <div id="evacuationModalContent" class="custom-modal-content" style="max-width: 1200px; height: 90vh;">
            <!-- Header Moderno -->
            <div class="custom-modal-header evacuation-header" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; border-radius: 16px 16px 0 0;">
                <button class="btn-regresar" id="cerrarEvacuacionModalBtn" aria-label="Cerrar" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">
                    <i class="fas fa-times"></i>
                </button>
                <div style="text-align: center; flex-grow: 1;">
                    <div style="font-size: 3rem; margin-bottom: 8px;">🚨</div>
                    <h3 style="font-size: 1.8rem; font-weight: 700; margin-bottom: 4px;">
                        <i class="fas fa-shield-alt"></i>
                        Sistema de Evacuación SurPass
                    </h3>
                    <p style="font-size: 1.1rem; opacity: 0.9;">
                        Personal en el Edificio: <span id="totalPersonasDentro" style="font-weight: 700; font-size: 1.3rem;">0</span> personas
                    </p>
                </div>
                <div class="evacuation-status-indicator active" style="width: 12px; height: 12px; border-radius: 50%; background: #10b981; margin-left: 20px; animation: pulse 2s infinite;"></div>
            </div>
            
            <!-- Cuerpo del Modal con Diseño Moderno -->
            <div class="custom-modal-body" style="padding: 0; height: calc(100% - 140px); display: flex; flex-direction: column;">
                
                <!-- Barra de Selección de Tipo -->
                <div style="padding: 24px; border-bottom: 2px solid #e2e8f0; background: #f8fafc;">
                    <h4 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 16px; color: #1e293b;">
                        <i class="fas fa-list-check"></i>
                        Seleccionar Tipo de Evacuación
                    </h4>
                    <div class="type-selection-modern" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <!-- Botón Simulacro Moderno -->
                        <button id="btnSimulacroModerno" class="type-card-modern simulacro" data-type="simulacro" style="
                            background: white;
                            border: 2px solid #e2e8f0;
                            border-radius: 12px;
                            padding: 20px;
                            text-align: center;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            position: relative;
                            overflow: hidden;
                        ">
                            <i class="fas fa-theater-masks" style="font-size: 2.5rem; color: #7c3aed; margin-bottom: 12px; display: block;"></i>
                            <h5 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 4px; color: #1e293b;">SIMULACRO</h5>
                            <p style="font-size: 0.85rem; color: #64748b; margin: 0;">Solo registra en logs de auditoría.<br>No modifica el historial real.</p>
                        </button>
                        
                        <!-- Botón Evacuación Real Moderna -->
                        <button id="btnRealModerno" class="type-card-modern real" data-type="real" style="
                            background: white;
                            border: 2px solid #e2e8f0;
                            border-radius: 12px;
                            padding: 20px;
                            text-align: center;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            position: relative;
                            overflow: hidden;
                        ">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; color: #dc2626; margin-bottom: 12px; display: block;"></i>
                            <h5 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 4px; color: #1e293b;">EVACUACIÓN REAL</h5>
                            <p style="font-size: 0.85rem; color: #64748b; margin: 0;">Registra salidas permanentes<br>y envía notificaciones de emergencia.</p>
                        </button>
                    </div>
                </div>
                
                <!-- Lista de Personal Moderna -->
                <div style="flex-grow: 1; padding: 24px; overflow-y: auto;">
                    <!-- Información del tipo seleccionado - movida aquí para estar dentro del scroll -->
                    <div id="infoTipoSeleccionadoModerno" style="
                        margin-bottom: 20px; 
                        padding: 16px; 
                        border-radius: 8px; 
                        display: none;
                        border-left: 4px solid;
                        background: #f8fafc;
                        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                    "></div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h4 style="font-size: 1.2rem; font-weight: 600; color: #1e293b;">
                            <i class="fas fa-users"></i>
                            Personal Disponible para Evacuación
                        </h4>
                        <div style="display: flex; gap: 12px;">
                            <button id="btnSeleccionarTodosModerno" class="btn-base btn-secondary" style="font-size: 0.875rem; padding: 8px 16px;">
                                <i class="fas fa-check-double"></i>
                                Seleccionar Todo
                            </button>
                            <button id="btnLimpiarSeleccionModerno" class="btn-base btn-secondary" style="font-size: 0.875rem; padding: 8px 16px;">
                                <i class="fas fa-times"></i>
                                Limpiar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Grid de Personal Moderno -->
                    <div id="personalGridModerno" style="
                        display: grid;
                        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
                        gap: 16px;
                    ">
                        <!-- Aquí se llenarán las tarjetas de personal dinámicamente -->
                        <div style="text-align: center; padding: 40px; color: #64748b; grid-column: 1 / -1;">
                            <div style="font-size: 3rem; margin-bottom: 16px; opacity: 0.5;">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                            <h5>Cargando personal...</h5>
                            <p>Obteniendo datos del sistema</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Barra de Acciones Moderna -->
            <div class="evacuation-actions" style="
                background: white;
                border-radius: 0 0 16px 16px;
                padding: 20px 24px;
                border-top: 2px solid #e2e8f0;
                display: flex;
                justify-content: space-between;
                align-items: center;
                position: sticky;
                bottom: 0;
                z-index: 10;
            ">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <span id="selectionCountModerno" style="
                        background: #2563eb;
                        color: white;
                        padding: 8px 16px;
                        border-radius: 20px;
                        font-weight: 600;
                        font-size: 0.875rem;
                    ">0</span>
                    <span style="color: #1e293b; font-weight: 500;">personas seleccionadas</span>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button id="btnCerrarEvacuacion" class="btn-base btn-secondary">
                        <i class="fas fa-times"></i>
                        Cerrar
                    </button>
                    <button id="btnConfirmarSalidas" class="btn-base btn-primary" disabled style="
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    ">
                        <i class="fas fa-play"></i>
                        Ejecutar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay de carga para evacuación -->
    <div id="evacuationLoadingOverlay" class="evacuation-loading">
        <div class="evacuation-spinner spinner"></div>
        <p id="evacuationLoadingText">Procesando...</p>
    </div>

    <!-- ✅ MODAL GENERAL DE NOTIFICACIONES PERSONALIZADO ✅ -->
    <div id="customNotificationModal" class="custom-modal-overlay">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <i id="notificationIcon" class="fas fa-info-circle"></i>
                <h3 id="notificationTitle">Notificación</h3>
            </div>
            <div class="custom-modal-body">
                <p id="notificationMessage"></p>
            </div>
            <div class="custom-modal-buttons" id="notificationButtons">
                <!-- Buttons will be injected here if confirmation is needed -->
                <button class="btn-base btn-primary" id="notificationOkBtn">Aceptar</button>
            </div>
        </div>
    </div>


    <script>
    // Variables globales
let personalGlobal = [];
let timeoutIdCedula;
let html5QrCodeScanner = null;
let isScannerActive = false;
let useJsQR = false; // Variable para alternar entre jsQR y html5-qrcode
let mostrarEstadisticas = true;
let formularioBloqueado = false; // Nueva variable para controlar el estado del formulario
let sonidosActivados = true; // Variable para controlar los sonidos
let evacuationMode = false;
let evacuationData = null;
let tipoEvacuacionSeleccionado = null;
let personasSeleccionadasEvacuacion = []; // Array para almacenar las cédulas de personas seleccionadas en el modal de evacuación

// Elementos HTML
const statsPanelDiv = document.getElementById('statsPanel');
const estadoEstadisticasSpan = document.getElementById('estadoEstadisticas');
const estadoEscanerSpan = document.getElementById('estadoEscaner');
const menuButton = document.getElementById('menuButton'); // Referencia al botón de menú

// Sistema de caché local
const SurPassCache = {
    guardarPersonalEnCache: function(personal) {
        try {
            localStorage.setItem('surpass-personal', JSON.stringify(personal));
            console.log('Personal guardado en caché local');
        } catch (error) {
            console.error('Error al guardar personal en caché:', error);
        }
    },
    obtenerPersonalDesdeCache: function() {
        try {
            const data = localStorage.getItem('surpass-personal');
            return data ? JSON.parse(data) : [];
        } catch (error) {
            console.error('Error al obtener personal desde caché:', error);
            return [];
        }
    },
    guardarTransaccionPendiente: function(transaccion) {
        try {
            let pendientes = this.obtenerTransaccionesPendientes();
            pendientes.push({...transaccion, timestamp: new Date().getTime() });
            localStorage.setItem('surpass-pendientes', JSON.stringify(pendientes));
            console.log('Transacción guardada en pendientes');
        } catch (error) {
            console.error('Error al guardar transacción pendiente:', error);
        }
    },
    obtenerTransaccionesPendientes: function() {
        try {
            const data = localStorage.getItem('surpass-pendientes');
            return data ? JSON.parse(data) : [];
        } catch (error) {
            console.error('Error al obtener transacciones pendientes:', error);
            return [];
        }
    },
    limpiarTransaccionesPendientes: function() {
        localStorage.removeItem('surpass-pendientes');
    }
};

// Historial en vivo
let historyCache = [];

// Sonidos
const successSound = document.getElementById('successSound');
const errorSound = document.getElementById('errorSound');
const scanSound = document.getElementById('scanSound'); // Añadido para el sonido de escaneo

// Inicializar sonidosActivados desde localStorage o valor predeterminado
try {
    sonidosActivados = localStorage.getItem('surpass-sounds') !== 'false'; // Por defecto, true
} catch (e) {
    console.error('Error al obtener configuración de sonidos:', e);
    sonidosActivados = true; // Valor predeterminado si hay error
}

// Pantalla completa
const lastRecordDiv = document.getElementById('lastRecord');
const lastCedulaP = document.getElementById('lastCedula');
const lastActionP = document.getElementById('lastAction');
const lastTimeP = document.getElementById('lastTime');

// Estadísticas en tiempo real
const entradasLiveSpan = document.querySelector('#entradasLive span');
const salidasLiveSpan = document.querySelector('#salidasLive span');
const miniChartDiv = document.getElementById('miniChart');

function gestionarSonidos() {
    // Inicializar sonidos desde localStorage como fuente única de verdad
    let sonidosActivados = localStorage.getItem('surpass-sounds') !== 'false';

    // Función interna para actualizar UI
    function actualizarUI() {
        const toggleSwitch = document.getElementById('toggleSounds');
        if (toggleSwitch) {
            toggleSwitch.checked = sonidosActivados;
        }
    }

    // Función interna para toggle
    function toggle() {
        sonidosActivados = !sonidosActivados;
        localStorage.setItem('surpass-sounds', sonidosActivados.toString());
        // Actualizar UI inmediatamente
        actualizarUI();
        // Sincronizar con servidor (sin bloquear UI)
        google.script.run
            .withSuccessHandler(function(result) {
                console.log('✅ Sonidos sincronizados con servidor');
            })
            .withFailureHandler(function(error) {
                console.warn('⚠️ No se pudo sincronizar con servidor, usando configuración local');
            })
            .toggleSonidos(sonidosActivados);
        showCustomNotification(`Sonidos ${sonidosActivados ? 'activados' : 'desactivados'}`, 'info'); // Usar custom notification
        document.getElementById('menuDropdown').classList.remove('show');
    }

    // Exponer funciones necesarias
    window.toggleSonidos = toggle;
    window.actualizarEstadoSonidos = actualizarUI;

    // Inicializar al cargar
    actualizarUI();
    return { sonidosActivados, toggle, actualizarUI };
}

// Inicializar cuando DOM esté listo
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', gestionarSonidos);
} else {
    gestionarSonidos();
}

/**
 * Función para reproducir sonidos con mejor manejo de errores
 */
function reproducirSonido(audioId) {
    if (!sonidosActivados) {
        console.log(`Sonidos desactivados, no se reproduce ${audioId}`);
        return;
    }
    try {
        const sonido = document.getElementById(audioId);
        if (!sonido) {
            console.error(`Elemento de audio '${audioId}' no encontrado`);
            return;
        }
        // Verificar si el audio está listo
        if (sonido.readyState >= 2) {
            sonido.pause();
            sonido.currentTime = 0;
            const playPromise = sonido.play();
            if (playPromise !== undefined) {
                playPromise
                    .then(() => {
                        console.log(`Sonido ${audioId} reproducido exitosamente`);
                    })
                    .catch(e => {
                        console.warn(`Error al reproducir sonido ${audioId}:`, e);
                        // Para navegadores que requieren interacción del usuario
                        if (e.name === 'NotAllowedError') {
                            const playOnClick = () => {
                                sonido.play().catch(err => console.error('Error en segundo intento:', err));
                                document.removeEventListener('click', playOnClick);
                            };
                            document.addEventListener('click', playOnClick, { once: true });
                        }
                    });
            }
        } else {
            console.warn(`Sonido ${audioId} no está listo (readyState: ${sonido.readyState})`);
            sonido.load();
            sonido.addEventListener('canplaythrough', () => {
                sonido.play().catch(e => console.error('Error al reproducir tras cargar:', e));
            }, { once: true });
        }
    } catch (e) {
        console.error(`Excepción al reproducir sonido ${audioId}:`, e);
    }
}

function bloquearFormulario() {
    formularioBloqueado = true;
    document.getElementById('cedula').disabled = true;
    document.querySelectorAll('input[name="respuesta"]').forEach(radio => radio.disabled = true);
    document.querySelector('input[type="submit"]').disabled = true;
    document.getElementById('qrButton').disabled = true;
    document.getElementById('limpiarCedula').disabled = true;
}

function desbloquearFormulario() {
    formularioBloqueado = false;
    document.getElementById('cedula').disabled = false;
    document.querySelectorAll('input[name="respuesta"]').forEach(radio => radio.disabled = false);
    document.querySelector('input[type="submit"]').disabled = false;
    document.getElementById('qrButton').disabled = false;
    document.getElementById('limpiarCedula').disabled = false;
}

// Funciones de carga
function mostrarLoading() {
    document.getElementById('loadingOverlay').style.display = 'flex';
}

function ocultarLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}

// Menú
function toggleMenu() {
    document.getElementById('menuDropdown').classList.toggle('show');
}

function appendLog(logEntry) {
    const logContent = document.getElementById('logContent');
    const p = document.createElement('p');
    p.className = logEntry.level;
    p.textContent = `${logEntry.timestamp} [${logEntry.level}] ${logEntry.message}`;
    if (logEntry.details && Object.keys(logEntry.details).length > 0) {
        p.textContent += ` | Detalles: ${JSON.stringify(logEntry.details)}`;
    }
    logContent.appendChild(p);
    logContent.scrollTop = logContent.scrollHeight;
}

// Procesar pendientes cuando hay conexión
function procesarPendientes() {
    if (!navigator.onLine) {
        console.log('Sin conexión. No se procesarán pendientes.');
        return;
    }
    const pendientes = SurPassCache.obtenerTransaccionesPendientes();
    if (pendientes.length === 0) return;
    console.log(`Procesando ${pendientes.length} transacciones pendientes...`);
    showCustomNotification(`Sincronizando ${pendientes.length} registros pendientes...`, 'warning'); // Usar custom notification
    let procesados = 0;
    pendientes.forEach((transaccion, index) => {
        setTimeout(() => {
            google.script.run
                .withSuccessHandler(function(result) {
                    procesados++;
                    console.log(`Transacción procesada (${procesados}/${pendientes.length})`);
                    if (procesados === pendientes.length) {
                        SurPassCache.limpiarTransaccionesPendientes();
                        showCustomNotification('Sincronización completada.', 'success'); // Usar custom notification
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Error al procesar transacción pendiente:', error);
                    showCustomNotification('Error al sincronizar algunos registros.', 'error'); // Usar custom notification
                })
                .handleHTMLFormSubmit(transaccion.cedula, transaccion.respuesta);
        }, index * 1000);
    });
}

// Función corregida para actualizar el estado de conexión
function actualizarEstadoConexion() {
    const indicador = document.getElementById('conexionIndicador');
    const texto = indicador.querySelector('.conexion-texto');
    if (navigator.onLine) {
        indicador.classList.remove('offline');
        indicador.classList.add('online');
        texto.textContent = 'En línea';
        // Procesar transacciones pendientes si hay alguna al reconectarse
        const pendientes = SurPassCache.obtenerTransaccionesPendientes();
        if (pendientes.length > 0) {
            procesarPendientes();
        }
    } else {
        indicador.classList.remove('online');
        indicador.classList.add('offline');
        texto.textContent = 'Sin conexión';
        showCustomNotification('No hay conexión a internet.', 'error'); // Usar custom notification
        appendLog({ timestamp: new Date().toISOString(), level: 'WARNING', message: 'Sin conexión a internet', details: {} });
    }
}

// ✅ FUNCIÓN COMPLETA UNIFICADA - REEMPLAZAR TODO
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Iniciando SurPass - Sistema Unificado v3.0');

    // ✅ 1. INICIALIZACIÓN DE CONEXIÓN
    actualizarEstadoConexion(); // LLAMA a la función, no está dentro de ella
    window.addEventListener('online', actualizarEstadoConexion);
    window.addEventListener('offline', actualizarEstadoConexion);

    // ✅ 2. INICIALIZACIÓN DE GESTIÓN DE SONIDOS
    if (typeof gestionarSonidos === 'function') {
        gestionarSonidos();
    }

    // ✅ 3. EVENT LISTENERS PRINCIPALES (con verificación de existencia)
    const elementos = {
        menuButton: document.getElementById('menuButton'),
        botonInfo: document.getElementById('botonInfo'),
        botonFinalizar: document.getElementById('botonFinalizar'),
        botonLimpiar: document.getElementById('botonLimpiar'),
        limpiarHistorialCentral: document.getElementById('limpiarHistorialCentral'),
        botonHistorial: document.getElementById('botonHistorial'),
        botonTema: document.getElementById('botonTema'),
        botonLogs: document.getElementById('botonLogs'),
        closeLogOverlay: document.getElementById('closeLogOverlay'),
        qrButton: document.getElementById('qrButton'),
        qrCloseButton: document.getElementById('qrCloseButton'),
        limpiarCedula: document.getElementById('limpiarCedula'),
        botonComentario: document.getElementById('botonComentario'),
        logCloseButton: document.getElementById('logCloseButton'),
        fullscreenToggle: document.getElementById('fullscreenToggle'),
        botonToggleEstadisticas: document.getElementById('botonToggleEstadisticas'),
        botonCambiarEscaner: document.getElementById('botonCambiarEscaner'),
        botonEvacuacion: document.getElementById('botonEvacuacion'),
        cerrarEvacuacionModalBtn: document.getElementById('cerrarEvacuacionModalBtn'),
        btnCerrarEvacuacion: document.getElementById('btnCerrarEvacuacion'),
        btnConfirmarSalidas: document.getElementById('btnConfirmarSalidas'),
        accessForm: document.getElementById('accessForm'),
        cedulaInput: document.getElementById('cedula'),
        // Solo botones modernos de evacuación (interface unificada)
        btnSimulacroModerno: document.getElementById('btnSimulacroModerno'),
        btnRealModerno: document.getElementById('btnRealModerno'),
        btnSeleccionarTodosModerno: document.getElementById('btnSeleccionarTodosModerno'),
        btnLimpiarSeleccionModerno: document.getElementById('btnLimpiarSeleccionModerno'),
        notificationOkBtn: document.getElementById('notificationOkBtn')
    };

    // Asignar eventos solo si los elementos existen
    if (elementos.menuButton) elementos.menuButton.addEventListener('click', toggleMenu);
    if (elementos.botonInfo) elementos.botonInfo.addEventListener('click', mostrarInformacion);
    if (elementos.botonFinalizar) elementos.botonFinalizar.addEventListener('click', finalizarTurno);
    if (elementos.botonLimpiar) elementos.botonLimpiar.addEventListener('click', limpiarTodo);
    if (elementos.limpiarHistorialCentral) elementos.limpiarHistorialCentral.addEventListener('click', limpiarTodo);
    if (elementos.botonHistorial) elementos.botonHistorial.addEventListener('click', mostrarVistaPrevia);
    if (elementos.botonTema) elementos.botonTema.addEventListener('click', cambiarTema);
    if (elementos.botonLogs) elementos.botonLogs.addEventListener('click', showLogOverlay);
    if (elementos.closeLogOverlay) {
        elementos.closeLogOverlay.addEventListener('click', function() {
            document.getElementById('logOverlay').style.display = 'none';
            document.getElementById('menuButton').style.display = 'block';
        });
    }
    if (elementos.qrButton) elementos.qrButton.addEventListener('click', iniciarEscanerQR);
    if (elementos.qrCloseButton) elementos.qrCloseButton.addEventListener('click', cerrarEscanerQR);
    if (elementos.limpiarCedula) elementos.limpiarCedula.addEventListener('click', limpiarCampoCedula);
    if (elementos.botonComentario) elementos.botonComentario.addEventListener('click', enviarComentario);
    if (elementos.logCloseButton) {
        elementos.logCloseButton.addEventListener('click', function() {
            document.getElementById('logOverlay').style.display = 'none';
            if (elementos.menuButton) elementos.menuButton.style.display = 'flex';
        });
    }
    if (elementos.fullscreenToggle) elementos.fullscreenToggle.addEventListener('click', toggleFullscreen);
    if (elementos.botonToggleEstadisticas) elementos.botonToggleEstadisticas.addEventListener('click', togglePanelEstadisticas);
    if (elementos.botonCambiarEscaner) elementos.botonCambiarEscaner.addEventListener('click', switchQRMode);
    if (elementos.botonEvacuacion) elementos.botonEvacuacion.addEventListener('click', mostrarEvacuacionChecklist);
    if (elementos.cerrarEvacuacionModalBtn) elementos.cerrarEvacuacionModalBtn.addEventListener('click', cerrarEvacuacionChecklist);
    if (elementos.btnCerrarEvacuacion) elementos.btnCerrarEvacuacion.addEventListener('click', cerrarEvacuacionChecklist);
    
    // El botón Ejecutar ahora procesa directamente sin modal de confirmación duplicado
    if (elementos.btnConfirmarSalidas) elementos.btnConfirmarSalidas.addEventListener('click', procesarEvacuacionDirecta);
    
    // Los event listeners para botones modernos de evacuación 
    // se configuran dinámicamente en configurarEventListenersModalEvacuacion()
    // cuando se muestra el modal, ya que los elementos no existen al cargar la página
    console.log('� Event listeners para evacuación se configurarán dinámicamente al mostrar modal...');
    
    if (elementos.btnConfirmarEvacuacionFinal) elementos.btnConfirmarEvacuacionFinal.addEventListener('click', ejecutarEvacuacionConfirmada);
    if (elementos.btnCancelarConfirmacionEvacuacion) elementos.btnCancelarConfirmacionEvacuacion.addEventListener('click', cerrarConfirmacionEvacuacion);
    if (elementos.cerrarConfirmacionEvacuacionBtn) elementos.cerrarConfirmacionEvacuacionBtn.addEventListener('click', cerrarConfirmacionEvacuacion);

    // Evento para el botón OK del modal de notificación general
    if (elementos.notificationOkBtn) {
        elementos.notificationOkBtn.addEventListener('click', function() {
            document.getElementById('customNotificationModal').classList.remove('show');
            // Si hay un callback pendiente de confirmación, ejecutarlo con 'true' por defecto para OK
            if (this.dataset.callbackId) {
                const callback = window[this.dataset.callbackId];
                if (typeof callback === 'function') {
                    callback(true);
                    delete window[this.dataset.callbackId]; // Limpiar el callback
                }
                delete this.dataset.callbackId;
            }
        });
    }

    // ✅ 4. FORMULARIO PRINCIPAL
    if (elementos.accessForm) {
        elementos.accessForm.addEventListener('submit', function(event) {
            event.preventDefault();
            enviarFormulario();
        });
    }

    // ✅ 5. INPUT DE CÉDULA
    if (elementos.cedulaInput) {
        elementos.cedulaInput.addEventListener('input', function() {
            if (formularioBloqueado) return;
            clearTimeout(timeoutIdCedula);
            timeoutIdCedula = setTimeout(() => {
                buscarCedulas(this.value);
            }, 300);
            const limpiarBtn = document.getElementById('limpiarCedula');
            if (limpiarBtn) {
                limpiarBtn.style.display = this.value ? 'block' : 'none';
            }
        });
    }

    // ✅ 6. BOTONES DE CERRAR VISTAS PREVIAS
    const cerrarVistaPreviaBtn = document.querySelector('#vistaPrevia .btn-regresar');
    if (cerrarVistaPreviaBtn) {
        cerrarVistaPreviaBtn.addEventListener('click', cerrarVistaPrevia);
    }
    const cerrarVistaPreviaHistorialBtn = document.querySelector('#vistaPreviaHistorial .btn-regresar');
    if (cerrarVistaPreviaHistorialBtn) {
        cerrarVistaPreviaHistorialBtn.addEventListener('click', cerrarVistaPreviaHistorial);
    }

    // ✅ 7. CLICK OUTSIDE HANDLERS
    document.addEventListener('click', function(event) {
        const cedulaSuggestions = document.getElementById('cedulaSuggestions');
        if (elementos.cedulaInput && cedulaSuggestions && event.target !== elementos.cedulaInput && !cedulaSuggestions.contains(event.target)) {
            cedulaSuggestions.style.display = 'none';
        }
        const menu = document.getElementById('menuDropdown');
        if (menu && elementos.menuButton && event.target !== elementos.menuButton && !elementos.menuButton.contains(event.target) && !menu.contains(event.target) && menu.classList.contains('show')) {
            menu.classList.remove('show');
        }
    });

    // ✅ 8. FULLSCREEN CHANGE HANDLER
    document.addEventListener('fullscreenchange', function() {
        const lastRecordDiv = document.getElementById('lastRecord');
        if (!document.fullscreenElement && lastRecordDiv) {
            lastRecordDiv.style.display = 'none';
        }
    });

    // ✅ 9. FUNCIONALIDAD DE EVACUACIÓN INTEGRADA (del primer DOMContentLoaded eliminado)
    console.log('🔧 Inicializando sistema de evacuación...');
    const elementosEvacuacion = ['evacuationModal', 'botonEvacuacion'];
    const faltantesEvacuacion = elementosEvacuacion.filter(id => !document.getElementById(id));
    if (faltantesEvacuacion.length > 0) {
        console.warn('⚠️ Elementos faltantes para evacuación:', faltantesEvacuacion);
    } else {
        console.log('✅ Sistema de evacuación listo');
    }

    // ✅ 10. HORA DE VERIFICACIÓN (del tercer DOMContentLoaded eliminado)
    const horaVerificacion = document.getElementById('horaVerificacion');
    if (horaVerificacion) {
        horaVerificacion.textContent = new Date().toLocaleTimeString('es-PA');
    }
    const btnActualizarLista = document.getElementById('btnActualizarLista');
    if (btnActualizarLista) {
        btnActualizarLista.addEventListener('click', function() {
            mostrarEvacuacionChecklist();
            if (horaVerificacion) {
                horaVerificacion.textContent = new Date().toLocaleTimeString('es-PA');
            }
        });
    }

    // ✅ 11. TOOLTIPS (del tercer DOMContentLoaded eliminado)
    try {
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        if (tooltipTriggerList.length > 0 && typeof bootstrap !== 'undefined') {
            tooltipTriggerList.forEach(function (tooltipTriggerEl) {
                new bootstrap.Tooltip(tooltipTriggerEl);
            });
            console.log('✅ Tooltips inicializados');
        }
    } catch (tooltipError) {
        console.warn('⚠️ Error inicializando tooltips:', tooltipError.message);
    }

    // ✅ 12. INICIALIZACIÓN DE COMPONENTES
    try {
        // Panel estadísticas arrastrable
        if (document.getElementById('statsPanel')) {
            makeStatsPanelDraggable();
        }
        // Cerrar escáner si existe
        if (typeof html5QrCodeScanner !== 'undefined' && html5QrCodeScanner) {
            cerrarEscanerQR();
        }
        // Cargar personal desde caché
        mostrarLoading();
        const personalCache = SurPassCache.obtenerPersonalDesdeCache();
        if (personalCache && personalCache.length > 0) {
            personalGlobal = personalCache;
            console.log("Personal cargado desde caché:", personalGlobal.length, "registros");
            ocultarLoading();
        }

        // Tema guardado
        const temaGuardado = localStorage.getItem('surpass-theme');
        if (temaGuardado === 'dark') {
            document.body.classList.add('dark-theme');
        }

        // ✅ 13. CARGAR DATOS DEL SERVIDOR
        google.script.run
            .withSuccessHandler(function(personal) {
                personalGlobal = personal;
                console.log("Personal actualizado desde servidor:", personalGlobal.length, "registros");
                SurPassCache.guardarPersonalEnCache(personal);
                ocultarLoading();
                cargarPersonal(); // Esto parece redundante si ya se actualizó personalGlobal
                updateStatsPanel();
                setInterval(updateStatsPanel, 30000);
                if (navigator.onLine) {
                    procesarPendientes();
                }
            })
            .withFailureHandler(function(error) {
                console.error('Error al cargar el personal desde el servidor:', error);
                if (personalCache && personalCache.length > 0) {
                    showCustomNotification('No se pudo actualizar la base de datos. Usando datos en caché.', 'warning');
                } else {
                    showCustomNotification('Error al cargar el personal: ' + error.message, 'error');
                }
                ocultarLoading();
            })
            .obtenerTodoElPersonal();

        // ✅ 14. CARGAR OPCIONES DEL MENÚ
        google.script.run
            .withSuccessHandler(function(opciones) {
                mostrarEstadisticas = opciones.mostrarEstadisticas || true;
                useJsQR = opciones.usarJsQR || false;
                sonidosActivados = opciones.hasOwnProperty('sonidosActivados') ? opciones.sonidosActivados : true;
                localStorage.setItem('surpass-sounds', sonidosActivados.toString());
                actualizarVisibilidadEstadisticas();
                actualizarEstadoEscaner();
                if (typeof actualizarEstadoSonidos === 'function') {
                    actualizarEstadoSonidos();
                }
                console.log('Opciones cargadas:', { mostrarEstadisticas, useJsQR, sonidosActivados });
            })
            .withFailureHandler(function(error) {
                console.error('Error al cargar opciones del menú:', error);
                sonidosActivados = localStorage.getItem('surpass-sounds') !== 'false';
                if (typeof actualizarEstadoSonidos === 'function') {
                    actualizarEstadoSonidos();
                }
                showCustomNotification('No se pudieron cargar las opciones del servidor. Usando configuración local.', 'warning');
            })
            .obtenerOpcionesMenu();

        // ✅ 15. INICIALIZAR ESTADÍSTICAS
        updateStatsPanel();
        setInterval(updateStatsPanel, 30000);

        // ✅ 16. APLICAR TEMA A ELEMENTOS
        applyThemeToElement(document.getElementById('contenidoVistaPrevia'), document.body.classList.contains('dark-theme') ? 'dark' : 'light');
        aplicarIdioma();

    } catch (initError) {
        console.error('Error en inicialización:', initError);
        ocultarLoading();
        showCustomNotification('Error al inicializar el sistema: ' + initError.message, 'error');
    }

    // ✅ 17. DIAGNÓSTICO (del cuarto DOMContentLoaded eliminado - solo en desarrollo)
    if (window.location.hostname === 'localhost' || window.location.hostname.includes('script.google.com')) {
        setTimeout(() => {
            console.log('💡 Ejecute ejecutarDiagnostico() en la consola para diagnóstico completo');
        }, 2000);
    }
    console.log('✅ SurPass inicializado correctamente - Sistema Unificado');
});

// Reemplazar la función toggleFullscreen actual
function toggleFullscreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
        lastRecordDiv.style.display = 'block';
    } else {
        document.exitFullscreen();
        lastRecordDiv.style.display = 'none';
    }
}

// Añadir este evento para detectar cuando se sale de pantalla completa con ESC
document.addEventListener('fullscreenchange', function() {
    if (!document.fullscreenElement) {
        // Si ya no estamos en pantalla completa, ocultar el div de último registro
        lastRecordDiv.style.display = 'none';
    }
});

// Funciones del formulario
function limpiarCampoCedula() {
    if (formularioBloqueado) return;
    document.getElementById('cedula').value = '';
    document.getElementById('infoSeleccionada').innerHTML = '';
    document.getElementById('cedulaSuggestions').style.display = 'none';
    document.getElementById('limpiarCedula').style.display = 'none';
}

function buscarCedulas(query) {
    if (!query || query.length < 2) {
        document.getElementById('cedulaSuggestions').style.display = 'none';
        return;
    }
    query = query.toLowerCase();
    const suggestions = personalGlobal.filter(item => 
        item.busqueda?.toLowerCase().includes(query) || 
        item.cedula.toLowerCase().includes(query) || 
        item.nombre.toLowerCase().includes(query) || 
        item.empresa.toLowerCase().includes(query)
    ).slice(0, 15);

    const suggestionsList = document.getElementById('cedulaSuggestions');
    suggestionsList.innerHTML = '';

    if (suggestions.length === 0) {
        suggestionsList.style.display = 'none';
        return;
    }

    suggestions.forEach(item => {
        const li = document.createElement('li');
        const cedulaHighlighted = item.cedula.toLowerCase().includes(query) ? 
            `<span style="background-color: rgba(255, 215, 0, 0.3)">${item.cedula}</span>` : item.cedula;
        
        const nombreEmpresa = `${item.nombre} - ${item.empresa}`;
        const nombreEmpresaLower = nombreEmpresa.toLowerCase();
        let nombreEmpresaHighlighted = '';
        if (nombreEmpresaLower.includes(query)) {
            const index = nombreEmpresaLower.indexOf(query);
            nombreEmpresaHighlighted = nombreEmpresa.substring(0, index) + 
                `<span style="background-color: rgba(255, 215, 0, 0.3)">${nombreEmpresa.substring(index, index + query.length)}</span>` + 
                nombreEmpresa.substring(index + query.length);
        } else {
            nombreEmpresaHighlighted = nombreEmpresa;
        }
        
        li.innerHTML = `<span>${cedulaHighlighted}</span><span>${nombreEmpresaHighlighted}</span>`;
        li.addEventListener('click', function() {
            selectCedula(item.cedula, item.nombre, item.empresa);
        });
        suggestionsList.appendChild(li);
    });
    suggestionsList.style.display = 'block';
}

function selectCedula(cedula, nombre, empresa) {
    document.getElementById('cedula').value = cedula;
    document.getElementById('infoSeleccionada').innerHTML = `<strong>${nombre}</strong> - ${empresa}`;
    document.getElementById('cedulaSuggestions').style.display = 'none';
    document.getElementById('limpiarCedula').style.display = 'block';
}

// Escáner QR
function iniciarEscanerQR() {
    if (isScannerActive) {
        console.log("El escáner ya está activo, cerrando primero...");
        cerrarEscanerQR();
    }
    const qrScanner = document.getElementById('qrScanner');
    qrScanner.style.display = 'flex';
    isScannerActive = true;
    menuButton.style.display = 'none'; // Ocultar el botón de menú
    if (useJsQR) {
        // Asegurarse de que el div de html5-qrcode esté oculto
        document.getElementById('qr-reader').style.display = 'none';
        document.getElementById('qrModalContent').style.display = 'block';
        startJsQRScanner();
    } else {
        // Asegurarse de que el div de jsQR esté oculto
        document.getElementById('qr-reader').style.display = 'block';
        document.getElementById('qrModalContent').style.display = 'none';
        iniciarNuevoEscaner();
    }
}

function switchQRMode() {
    google.script.run
        .withSuccessHandler(function(result) {
            useJsQR = result.usarJsQR;
            actualizarEstadoEscaner();
            showCustomNotification(result.message, 'info'); // Usar custom notification
            cerrarEscanerQR(); // Cerrar el escáner actual antes de reabrir
            document.getElementById('menuDropdown').classList.remove('show');
        })
        .withFailureHandler(function(error) {
            showCustomNotification('Error al cambiar modo de escaneo: ' + error.message, 'error'); // Usar custom notification
        })
        .toggleEscaner(!useJsQR); // Invierte el estado actual
}

// Función para iniciar el escáner con el tamaño guardado
function iniciarNuevoEscaner() {
    try {
        const qrBoxSize = parseInt(localStorage.getItem('surpass-qrBoxSize')) || 250;
        html5QrCodeScanner = new Html5QrcodeScanner(
            "qr-reader", { fps: 10, qrbox: { width: qrBoxSize, height: qrBoxSize }, rememberLastUsedCamera: true, aspectRatio: 1.7777778 }
        );
        html5QrCodeScanner.render(
            (decodedText) => onQRCodeSuccess(decodedText),
            (error) => onQRCodeError(error)
        );
    } catch (error) {
        console.error("Error al iniciar el escáner QR:", error);
        showCustomNotification("Error al iniciar el escáner QR. Intente de nuevo.", "error"); // Usar custom notification
        cerrarEscanerQR();
    }
}

/**
 * Función para detener y limpiar el escáner QR (tanto html5-qrcode como jsQR)
 */
function cerrarEscanerQR() {
    console.log("🔄 Cerrando escáner QR unificado...");
    const qrScannerDiv = document.getElementById('qrScanner');
    const menuButton = document.getElementById('menuButton');

    // 1. Detener html5-qrcode scanner
    if (html5QrCodeScanner && isScannerActive) {
        try {
            html5QrCodeScanner.stop().then(() => {
                console.log("✅ html5QrCodeScanner detenido y limpiado.");
                // Opcional: limpiar el contenido del div si es necesario
                document.getElementById('qr-reader').innerHTML = ''; 
            }).catch(err => {
                console.warn("⚠️ Error al detener html5QrCodeScanner:", err);
            });
        } catch (e) {
            console.warn("⚠️ Excepción al detener html5QrCodeScanner:", e);
        }
        html5QrCodeScanner = null; // Resetear la instancia
    }

    // 2. Detener jsQR scanner (si estaba activo)
    const video = document.getElementById('qrVideo');
    if (video && video.srcObject) {
        try {
            video.srcObject.getTracks().forEach(track => {
                track.stop(); // Detener cada track de la cámara
                console.log("✅ Track de cámara jsQR detenido.");
            });
            video.srcObject = null; // Limpiar la referencia al stream
        } catch (e) {
            console.warn("⚠️ Error al detener stream de video jsQR:", e);
        }
    }

    // 3. Resetear estado global y ocultar UI
    isScannerActive = false;
    if (qrScannerDiv) {
        qrScannerDiv.style.display = 'none';
    }
    if (menuButton) {
        menuButton.style.display = 'flex'; // Restaurar el botón de menú
    }
    console.log("✅ Escáner QR cerrado completamente y UI restaurada.");
}


function iniciarJsQRUnificado() {
    const video = document.getElementById('qrVideo');
    const canvas = document.getElementById('qrCanvas');
    const context = canvas.getContext('2d');

    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(stream => {
            video.srcObject = stream;
            video.play();
            // Asegurarse de que el bucle de escaneo solo se inicie una vez
            if (!video.dataset.scanLoopActive) {
                video.dataset.scanLoopActive = 'true';
                jsQRtick();
            }
        })
        .catch(err => {
            showCustomNotification('Error al acceder a la cámara: ' + err.message, 'error'); // Usar custom notification
            cerrarEscanerQR();
        });

    function jsQRtick() {
        if (!isScannerActive || !video.dataset.scanLoopActive) return; // Detener si el escáner no está activo o el bucle se detuvo
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);

            if (code) {
                onQRCodeSuccess(code.data);
                // No llamar a cerrarQrModal aquí, onQRCodeSuccess lo maneja
                return;
            }
        }
        requestAnimationFrame(jsQRtick);
    }
}

function onQRCodeSuccess(decodedText) {
    console.log("QR Code detectado:", decodedText);
    try {
        if (sonidosActivados) {
            const scanSound = document.getElementById('scanSound');
            if (scanSound) {
                scanSound.currentTime = 0;
                scanSound.play().catch(e => console.error("Error al reproducir sonido de escaneo:", e));
            } else {
                console.error("Elemento de audio 'scanSound' no encontrado");
            }
        }
    } catch (e) {
        console.error("Error al reproducir sonido:", e);
    }

    const cedula = extraerCedula(decodedText) || decodedText;
    document.getElementById('cedula').value = cedula;
    const limpiarBtn = document.getElementById('limpiarCedula');
    limpiarBtn.style.display = 'block';

    const personaEncontrada = personalGlobal.find(p => 
        p.cedula === cedula || 
        (p.cedulaNormalizada && p.cedulaNormalizada === cedula.replace(/[^\d]/g, ''))
    );

    if (personaEncontrada) {
        document.getElementById('infoSeleccionada').innerHTML = `<strong>${personaEncontrada.nombre}</strong> - ${personaEncontrada.empresa}`;
        showCustomNotification(`Documento identificado: ${cedula}\n${personaEncontrada.nombre} - ${personaEncontrada.empresa}`, 'success'); // Usar custom notification
    } else {
        document.getElementById('infoSeleccionada').innerHTML = '<span style="color: red;">Persona no encontrada</span>';
        showCustomNotification(`Documento identificado: ${cedula}\nPersona no encontrada`, 'error'); // Usar custom notification
    }
    cerrarEscanerQR(); // Asegurarse de cerrar el escáner después de un éxito
}

function onQRCodeError(error) {
    if (error !== "QR code parse error, error = NotFoundException: No MultiFormat Readers were able to detect the code.") {
        console.warn('Error de escaneo QR:', error);
    }
}


function extraerCedula(qrData) {
    if (!qrData) return null;
    console.log("Datos QR recibidos:", qrData);

    const patronPanama = /Texto\s*-\s*([\w\-]+)/i;
    const matchPanama = qrData.match(patronPanama);
    if (matchPanama && matchPanama[1]) {
        console.log("Cédula panameña encontrada:", matchPanama[1]);
        return matchPanama[1];
    }

    qrData = qrData.replace(/[\r\n\t]/g, ' ').replace(/\s+/g, ' ').trim();

    // Intento de extraer de JSON
    try {
        const jsonData = JSON.parse(qrData);
        const campoPosibles = ['cedula', 'cédula', 'documento', 'id', 'identificacion', 'identificación', 'numero', 'número', 'dni', 'doc', 'num_doc', 'no_doc', 'nro_doc', 'num', 'no', 'nro' ];
        for (const campo of campoPosibles) {
            if (jsonData[campo]) {
                const valor = String(jsonData[campo]).trim();
                if (/^[\w\-]{5,15}$/.test(valor)) { // Cédulas de 5 a 15 caracteres alfanuméricos/guiones
                    return valor;
                }
            }
        }
        // Si no se encuentra en campos específicos, buscar en cualquier valor de propiedad
        for (const key in jsonData) {
            const valor = String(jsonData[key]);
            if (/^[\w\-]{5,15}$/.test(valor)) {
                return valor;
            }
        }
    } catch (e) {
        console.log("No es JSON:", e);
    }

    // Patrones de cédula más generales
    const patronesCedula = [
        /\b[Cc][EeÉé][Dd][Uu][Ll][Aa][:=\s-]*(\d[\d\s-]*\d)\b/i, // "Cedula: 123-456-789"
        /\bID[:=\s-]*(\d[\d\s-]*\d)\b/i, // "ID: 123456789"
        /\bDNI[:=\s-]*(\d[\d\s-]*\d)\b/i, // "DNI: 123456789"
        /\bDOC(UMENTO)?[:=\s-]*(\d[\d\s-]*\d)\b/i, // "DOC: 123456789"
        /\bV-(\d[\d\s-]*\d)\b/i, // "V-12345678" (Venezuela)
        /\bE-(\d[\d\s-]*\d)\b/i, // "E-12345678" (Ecuador)
        /\b([A-Z]?[\d]+-[\d]+-[\d]+)\b/, // Formato panameño: "8-123-456", "PE-1-2-3"
        /\b([\d]+-[\d]+-[\d]+)\b/ // Formato panameño sin letra inicial
    ];

    let cedulaOriginal;
    for (const patron of patronesCedula) {
        const match = qrData.match(patron);
        if (match) {
            // Algunos patrones tienen el resultado en match[2], otros en match[1]
            const resultado = match[2] || match[1];
            if (resultado) {
                cedulaOriginal = resultado.replace(/\s/g, ''); // Eliminar espacios
                // Validar que el resultado tenga un formato razonable de cédula
                if (/^[A-Z0-9\-]{5,15}$/i.test(cedulaOriginal)) {
                    return cedulaOriginal;
                }
            }
        }
    }

    // Último recurso: buscar secuencias de 5 a 12 dígitos
    const coincidenciasNumeros = qrData.match(/\d{5,12}/g);
    if (coincidenciasNumeros && coincidenciasNumeros.length > 0) {
        // Priorizar números que se parezcan más a una cédula (ej. 8-10 dígitos)
        const numerosPrioritarios = coincidenciasNumeros.filter(num => /^\d{8,10}$/.test(num));
        if (numerosPrioritarios.length > 0) return numerosPrioritarios[0];
        return coincidenciasNumeros[0]; // Devolver el primer número encontrado
    }

    return null; // Si no se encuentra nada
}


// ✅ CORRECCIÓN EN EL FRONTEND (formulario.html)
// Busca la función enviarFormulario() y reemplaza la parte del withSuccessHandler
function enviarFormulario() {
    if (formularioBloqueado) {
        showCustomNotification('Debe enviar el comentario antes de continuar.', 'error');
        return;
    }
    const respuesta = document.querySelector('input[name="respuesta"]:checked');
    if (!respuesta) {
        document.getElementById('radioError').style.display = 'block';
        return;
    } else {
        document.getElementById('radioError').style.display = 'none';
    }
    const cedula = document.getElementById('cedula').value.trim();
    if (!cedula) {
        showCustomNotification('Por favor ingrese una cédula', 'error');
        return;
    }

    // Mostrar el indicador de carga antes de continuar
    mostrarLoading();

    if (!navigator.onLine) {
        handleOfflineSubmit(cedula, respuesta.value);
        ocultarLoading();
        return;
    }

    google.script.run
        .withSuccessHandler(function(result) {
            ocultarLoading();
            // Registrar en el log
            appendLog(result.log || { timestamp: new Date().toISOString(), level: 'INFO', message: 'Formulario procesado', details: {} });

            // ✅ DETERMINAR EL COLOR DEL MENSAJE
            const colorMensaje = result.color || 'success'; // Default to 'success'

            if (result.comentarioObligatorio) {
                showCustomNotification(result.message, 'error'); // Denegado, requiere comentario
                document.getElementById('cierreComentario').style.display = 'block';
                document.getElementById('botonComentario').style.display = 'block';
                bloquearFormulario();
            } else {
                // ✅ CONSTRUIR MENSAJE DE NOTIFICACIÓN CORREGIDO
                let mensajeCompleto = result.message;
                // ✅ SIEMPRE MOSTRAR NOMBRE Y EMPRESA PARA ACCESOS PERMITIDOS
                if (result.nombre && result.empresa) { // Si hay nombre y empresa en el resultado
                    mensajeCompleto += `\nNombre: ${result.nombre}\nEmpresa: ${result.empresa}`;
                }

                // ✅ MOSTRAR NOTIFICACIÓN CON INFORMACIÓN COMPLETA
                showCustomNotification(mensajeCompleto, colorMensaje); // Usar el color determinado

                // Actualizar la interfaz
                updateLiveHistory(cedula, respuesta.value);
                reproducirSonido('successSound');

                // Limpiar el formulario
                document.getElementById('cedula').value = '';
                document.getElementById('infoSeleccionada').innerHTML = '';
                document.querySelectorAll('input[name="respuesta"]').forEach(radio => radio.checked = false);
                document.getElementById('limpiarCedula').style.display = 'none';
            }

            // Mostrar notificación en pantalla completa si es necesario
            if (document.fullscreenElement) {
                const lastCedulaP = document.getElementById('lastCedula');
                const lastActionP = document.getElementById('lastAction');
                const lastTimeP = document.getElementById('lastTime');
                const lastRecordDiv = document.getElementById('lastRecord');
                if (lastCedulaP && lastActionP && lastTimeP && lastRecordDiv) {
                    lastCedulaP.textContent = `Cédula: ${cedula}`;
                    lastActionP.textContent = `Acción: ${respuesta.value === 'entrada' ? 'Entrada' : 'Salida'}`;
                    lastTimeP.textContent = `Hora: ${new Date().toLocaleTimeString()}`;
                    lastRecordDiv.classList.add('show');
                    setTimeout(() => {
                        lastRecordDiv.classList.remove('show');
                        if (!document.fullscreenElement) {
                            lastRecordDiv.style.display = 'none';
                        }
                    }, 3000);
                }
            }
        })
        .withFailureHandler(function(error) {
            ocultarLoading();
            showCustomNotification('Error: ' + error.message, 'error'); // Usar custom notification
            reproducirSonido('errorSound');
            console.error('Error:', error);
            appendLog({ timestamp: new Date().toISOString(), level: 'ERROR', message: 'Error procesando formulario', details: { error: error.message } });
        })
        .handleHTMLFormSubmit(cedula, respuesta.value);
}

function handleOfflineSubmit(cedula, respuestaValue) {
    const personaEncontrada = personalGlobal.find(p => p.cedula === cedula || p.cedula.toLowerCase() === cedula.toLowerCase());
    const resultado = {
        message: personaEncontrada ? 'Registro guardado localmente (sin conexión)' : 'Acceso Denegado - Verificar cuando haya conexión',
        nombre: personaEncontrada ? personaEncontrada.nombre : 'DENEGADO',
        empresa: personaEncontrada ? personaEncontrada.empresa : 'No registrada',
        estadoAcceso: personaEncontrada ? 'Acceso Permitido (Pendiente)' : 'Acceso Denegado',
        color: personaEncontrada ? 'warning' : 'error' // Usar 'warning' para pendiente, 'error' para denegado
    };

    SurPassCache.guardarTransaccionPendiente({ cedula: cedula, respuesta: respuestaValue, offline: true });

    showCustomNotification(
        `${resultado.message}\nNombre: ${resultado.nombre}\nEmpresa: ${resultado.empresa}\nSe sincronizará cuando haya conexión.`,
        resultado.color
    );
    appendLog({ timestamp: new Date().toISOString(), level: 'WARNING', message: 'Registro offline guardado', details: { cedula, respuesta: respuestaValue } });

    if (resultado.estadoAcceso.includes('Permitido')) {
        document.getElementById('cedula').value = '';
        document.getElementById('infoSeleccionada').innerHTML = '';
        document.querySelectorAll('input[name="respuesta"]').forEach(radio => radio.checked = false);
        document.getElementById('limpiarCedula').style.display = 'none';
    } else if (resultado.estadoAcceso === 'Acceso Denegado') {
        document.getElementById('cierreComentario').style.display = 'block';
        document.getElementById('botonComentario').style.display = 'block';
        bloquearFormulario(); // Bloquear el formulario en modo offline
    }
}

function enviarComentario() {
    const comentario = document.getElementById('comentarioCierre').value.trim();
    const cedula = document.getElementById('cedula').value.trim();

    if (!comentario) {
        showCustomNotification('Por favor ingrese un comentario', 'error');
        return;
    }

    if (!navigator.onLine) {
        showCustomNotification('No hay conexión a internet. El comentario se guardará cuando haya conexión.', 'warning');
        SurPassCache.guardarTransaccionPendiente({ cedula: cedula, comentario: comentario, tipo: 'comentario', offline: true });
        appendLog({ timestamp: new Date().toISOString(), level: 'WARNING', message: 'Comentario offline guardado', details: { cedula, comentario } });
        desbloquearFormulario();
        limpiarFormularioDespuesDeComentario();
        return;
    }

    mostrarLoading();
    google.script.run
        .withSuccessHandler(function(result) {
            ocultarLoading();
            showCustomNotification(result.message, 'success');
            appendLog(result.log || { timestamp: new Date().toISOString(), level: 'INFO', message: 'Comentario enviado', details: {} });
            desbloquearFormulario();
            limpiarFormularioDespuesDeComentario();
        })
        .withFailureHandler(function(error) {
            ocultarLoading();
            showCustomNotification('Error: ' + error.message, 'error');
            console.error('Error:', error);
            appendLog({ timestamp: new Date().toISOString(), level: 'ERROR', message: 'Error enviando comentario', details: { error: error.message, cedula: cedula, comentario: comentarioCierre, usuario: obtenerUsuarioActual() } });
        })
        .handleCommentSubmit(cedula, comentario);
}

function limpiarFormularioDespuesDeComentario() {
    document.getElementById('cedula').value = '';
    document.getElementById('infoSeleccionada').innerHTML = '';
    document.getElementById('comentarioCierre').value = '';
    document.getElementById('cierreComentario').style.display = 'none';
    document.getElementById('botonComentario').style.display = 'none';
    document.getElementById('cedulaSuggestions').style.display = 'none';
    document.getElementById('limpiarCedula').style.display = 'none';
    document.querySelectorAll('input[name="respuesta"]').forEach(radio => radio.checked = false);
}

function mostrarVistaPrevia() {
    mostrarLoading();
    google.script.run
        .withSuccessHandler(function(html) {
            ocultarLoading();
            document.getElementById('contenidoVistaPrevia').innerHTML = html;
            document.getElementById('vistaPrevia').style.display = 'block';
            document.getElementById('menuDropdown').classList.remove('show');
            menuButton.style.display = 'none'; // Ocultar el botón de menú
            // Aplicar el tema actual a la vista previa
            applyThemeToElement(document.getElementById('contenidoVistaPrevia'), document.body.classList.contains('dark-theme') ? 'dark' : 'light');
            appendLog({ timestamp: new Date().toISOString(), level: 'INFO', message: 'Vista previa mostrada', details: {} });
        })
        .withFailureHandler(function(error) {
            ocultarLoading();
            showCustomNotification('Error al cargar vista previa: ' + error.message, 'error');
            appendLog({ timestamp: new Date().toISOString(), level: 'ERROR', message: 'Error cargando vista previa', details: { error: error.message } });
        })
        .mostrarVistaPreviaRondas(document.getElementById('cedula').value);
}

function cambiarTema() {
    const body = document.body;
    if (body.classList.contains('dark-theme')) {
        body.classList.remove('dark-theme');
        localStorage.setItem('surpass-theme', 'light');
        showCustomNotification('Tema claro activado', 'success');
        applyThemeToIframes('light');
    } else {
        body.classList.add('dark-theme');
        localStorage.setItem('surpass-theme', 'dark');
        showCustomNotification('Tema oscuro activado', 'success');
        applyThemeToIframes('dark');
    }
    document.getElementById('menuDropdown').classList.remove('show');
    appendLog({ timestamp: new Date().toISOString(), level: 'INFO', message: 'Tema cambiado', details: { tema: body.classList.contains('dark-theme') ? 'oscuro' : 'claro' } });
}

function applyThemeToIframes(theme) {
    try {
        const vistaPreviaContent = document.getElementById('contenidoVistaPrevia');
        const vistaPreviaHistorialContent = document.getElementById('vistaPreviaHistorialContenido');
        if (vistaPreviaContent) applyThemeToElement(vistaPreviaContent, theme);
        if (vistaPreviaHistorialContent) applyThemeToElement(vistaPreviaHistorialContent, theme);
    } catch (e) {
        console.error('Error al aplicar tema a iframes:', e);
    }
}

function applyThemeToElement(element, theme) {
    if (!element) return;
    // Resetear estilos inline para que CSS se encargue
    element.style.backgroundColor = '';
    element.style.color = '';

    // Aplicar clase de tema al contenedor principal si no la tiene
    if (theme === 'dark' && !element.classList.contains('dark-theme')) {
        element.classList.add('dark-theme');
    } else if (theme === 'light' && element.classList.contains('dark-theme')) {
        element.classList.remove('dark-theme');
    }

    // Asegurar que los elementos internos también reaccionen al tema
    const elementsToStyle = element.querySelectorAll('table, th, td, p, h1, h2, h3, h4, h5, h6, li, span, div');
    elementsToStyle.forEach(el => {
        // Eliminar estilos inline que puedan interferir con las reglas CSS del tema
        el.style.backgroundColor = '';
        el.style.color = '';
        el.style.borderColor = '';
    });

    // Forzar re-evaluación de estilos CSS si es necesario (ej. para tablas nth-child(even))
    // Esto es un truco, idealmente el CSS debería ser robusto por sí mismo
    element.offsetHeight; // Trigger reflow
}


function mostrarInformacion() {
    mostrarLoading();
    google.script.run
        .withSuccessHandler(function(html) {
            ocultarLoading();
            document.getElementById('vistaPreviaHistorialContenido').innerHTML = html;
            document.getElementById('vistaPreviaHistorial').style.display = 'block';
            document.getElementById('menuDropdown').classList.remove('show');
            menuButton.style.display = 'none'; // Ocultar el botón de menú
            // Aplicar el tema actual a la vista previa del historial
            applyThemeToElement(document.getElementById('vistaPreviaHistorialContenido'), document.body.classList.contains('dark-theme') ? 'dark' : 'light');
            appendLog({ timestamp: new Date().toISOString(), level: 'INFO', message: 'Información del sistema mostrada', details: {} });
        })
        .withFailureHandler(function(error) {
            ocultarLoading();
            showCustomNotification('Error al cargar información: ' + error.message, 'error');
            appendLog({ timestamp: new Date().toISOString(), level: 'ERROR', message: 'Error cargando información', details: { error: error.message } });
        })
        .mostrarInformacionSistema();
}

// Reemplaza la función finalizarTurno() existente:
function finalizarTurno() {
    document.getElementById('menuDropdown').classList.remove('show');
    showCustomNotification('¿Está seguro de que desea finalizar el turno?', 'warning', true, function(confirm) {
        if (!confirm) return;
        if (!navigator.onLine) {
            showCustomNotification('No hay conexión a internet.', 'error');
            return;
        }
        mostrarLoading();
        google.script.run
            .withSuccessHandler(function(result) {
                ocultarLoading();
                showCustomNotification('Turno finalizado correctamente. Por favor, limpie el historial.', 'success');
                // Mostrar el botón de limpiar en el centro de la pantalla
                document.getElementById('limpiarHistorialCentral').style.display = 'block';
                // Ocultar el botón en el menú solo por si acaso
                document.getElementById('botonLimpiar').style.display = 'none';
                appendLog({ timestamp: new Date().toISOString(), level: 'INFO', message: 'Turno finalizado', details: {} });
            })
            .withFailureHandler(function(error) {
                ocultarLoading();
                showCustomNotification('Error al finalizar turno: ' + error.message, 'error');
                appendLog({ timestamp: new Date().toISOString(), level: 'ERROR', message: 'Error al finalizar turno', details: { error: error.message } });
            })
            .finalizarTurno();
    });
}

// Reemplaza la función limpiarTodo() existente:
function limpiarTodo() {
    showCustomNotification('¿Está seguro de que desea limpiar el historial?', 'warning', true, function(confirm) {
        if (!confirm) return;
        document.getElementById('cedula').value = '';
        document.getElementById('infoSeleccionada').innerHTML = '';
        document.getElementById('cedulaSuggestions').style.display = 'none';
        document.getElementById('limpiarCedula').style.display = 'none';
        document.querySelectorAll('input[name="respuesta"]').forEach(radio => radio.checked = false);
        document.getElementById('cierreComentario').style.display = 'none';
        document.getElementById('comentarioCierre').value = '';
        document.getElementById('radioError').style.display = 'none';

        mostrarLoading();
        google.script.run
            .withSuccessHandler(function(result) {
                ocultarLoading();
                if (result.exito) {
                    showCustomNotification(result.mensaje, 'success');
                    // Ocultar ambos botones de limpiar
                    document.getElementById('limpiarHistorialCentral').style.display = 'none';
                    document.getElementById('botonLimpiar').style.display = 'none';
                } else {
                    showCustomNotification(result.mensaje, 'error');
                }
                appendLog({ timestamp: new Date().toISOString(), level: 'INFO', message: 'Intento de limpieza de historial', details: { resultado: result.exito } });
            })
            .withFailureHandler(function(error) {
                ocultarLoading();
                showCustomNotification('Error al limpiar: ' + error.message, 'error');
                appendLog({ timestamp: new Date().toISOString(), level: 'ERROR', message: 'Error al limpiar historial', details: { error: error.message } });
            })
            .limpiarRegistros();
        document.getElementById('menuDropdown').classList.remove('show');
    });
}

/**
 * ✅ FUNCIÓN showCustomNotification: Reemplaza showNotification
 * Muestra un modal de notificación personalizado.
 * @param {string} message - El mensaje a mostrar.
 * @param {string} type - 'success', 'error', 'warning', 'info', 'orange'. Determina el color y el ícono.
 * @param {boolean} [withConfirmation=false] - Si se requiere confirmación (Sí/No).
 * @param {function} [callback] - Función a ejecutar después de la confirmación.
 */
function showCustomNotification(message, type = 'info', withConfirmation = false, callback = null) {
    const modal = document.getElementById('customNotificationModal');
    const header = modal.querySelector('.custom-modal-header');
    const icon = document.getElementById('notificationIcon');
    const title = document.getElementById('notificationTitle');
    const msg = document.getElementById('notificationMessage');
    const buttonsDiv = document.getElementById('notificationButtons');

    // Limpiar clases de color anteriores
    header.classList.remove('success', 'error', 'warning', 'info', 'orange');

    // Configurar color y título según el tipo
    let iconClass = 'fas fa-info-circle';
    let defaultTitle = 'Notificación';
    switch (type) {
        case 'success':
            header.classList.add('success');
            iconClass = 'fas fa-check-circle';
            defaultTitle = 'Éxito';
            break;
        case 'error':
            header.classList.add('error');
            iconClass = 'fas fa-times-circle';
            defaultTitle = 'Error';
            break;
        case 'warning':
            header.classList.add('warning');
            iconClass = 'fas fa-exclamation-triangle';
            defaultTitle = 'Advertencia';
            break;
        case 'orange': // Añadido para el color 'orange'
            header.classList.add('orange');
            iconClass = 'fas fa-exclamation-circle';
            defaultTitle = 'Atención';
            break;
        case 'info':
        default:
            header.classList.add('info');
            iconClass = 'fas fa-info-circle';
            defaultTitle = 'Información';
            break;
    }

    icon.className = iconClass;
    title.textContent = defaultTitle;
    msg.textContent = message; // Usar textContent para seguridad y para respetar \n

    // Limpiar botones anteriores
    buttonsDiv.innerHTML = '';

    if (withConfirmation) {
        const yesBtn = document.createElement('button');
        yesBtn.className = 'btn-base btn-success';
        yesBtn.textContent = 'Sí';
        yesBtn.addEventListener('click', function() {
            modal.classList.remove('show');
            if (callback) callback(true);
        });

        const noBtn = document.createElement('button');
        noBtn.className = 'btn-base btn-danger';
        noBtn.textContent = 'No';
        noBtn.addEventListener('click', function() {
            modal.classList.remove('show');
            if (callback) callback(false);
        });
        
        buttonsDiv.appendChild(yesBtn);
        buttonsDiv.appendChild(noBtn);
    } else {
        const okBtn = document.createElement('button');
        okBtn.className = 'btn-base btn-primary';
        okBtn.textContent = 'Aceptar';
        okBtn.addEventListener('click', function() {
            modal.classList.remove('show');
            if (callback) callback(); // Ejecutar callback sin argumentos para 'OK'
        });
        buttonsDiv.appendChild(okBtn);
    }

    modal.classList.add('show');
}


function cargarPersonal() {
    google.script.run
        .withSuccessHandler(function(data) {
            personalGlobal = data;
        })
        .obtenerTodoElPersonal();
}

// Funciones para la interfaz
function togglePanelEstadisticas() {
    google.script.run
        .withSuccessHandler(function(result) {
            mostrarEstadisticas = result.mostrarEstadisticas;
            actualizarVisibilidadEstadisticas();
            showCustomNotification(result.message, 'info');
            document.getElementById('menuDropdown').classList.remove('show');
        })
        .withFailureHandler(function(error) {
            showCustomNotification('Error al cambiar la visibilidad de las estadísticas: ' + error.message, 'error');
        })
        .toggleEstadisticas(!mostrarEstadisticas); // Invierte el estado actual
}

// Actualizar visibilidad del panel de estadísticas y el interruptor
function actualizarVisibilidadEstadisticas() {
    statsPanelDiv.style.display = mostrarEstadisticas ? 'block' : 'none';
    document.getElementById('toggleStats').checked = mostrarEstadisticas; // Sincroniza el interruptor
}

// Actualizar estado del escáner y el interruptor
function actualizarEstadoEscaner() {
    document.getElementById('toggleScanner').checked = useJsQR; // Sincroniza el interruptor
}

// Estadísticas en tiempo real
function updateStatsPanel() {
    if (!mostrarEstadisticas) return;

    google.script.run
        .withSuccessHandler(function(stats) {
            entradasLiveSpan.textContent = stats.entradas;
            salidasLiveSpan.textContent = stats.salidas;

            // Animación
            entradasLiveSpan.style.animation = 'countUp 0.5s ease';
            salidasLiveSpan.style.animation = 'countUp 0.5s ease';
            setTimeout(() => {
                entradasLiveSpan.style.animation = '';
                salidasLiveSpan.style.animation = '';
            }, 500);

            // Gráfica
            drawMiniChart(stats.entradas, stats.salidas);

            // Si hay registros recientes, actualizar el historial
            if (stats.recentRecords && stats.recentRecords.length > 0) {
                updateLiveHistoryFromStats(stats.recentRecords);
            }
        })
        .withFailureHandler(function(error) {
            console.error('Error al obtener estadísticas:', error);
        })
        .obtenerEstadisticas();
}

// Función para dibujar el mini gráfico de estadísticas
function drawMiniChart(entradas, salidas) {
    google.charts.load('current', { 'packages': ['corechart'] });
    google.charts.setOnLoadCallback(function() {
        const data = google.visualization.arrayToDataTable([
            ['Acción', 'Cantidad'],
            ['Entradas', entradas],
            ['Salidas', salidas]
        ]);

        const options = {
            pieHole: 0.4,
            width: 200,
            height: 100,
            legend: 'none',
            colors: ['#43a047', '#ff9800'],
            backgroundColor: 'transparent',
            chartArea: { width: '90%', height: '90%' }
        };

        const chart = new google.visualization.PieChart(miniChartDiv);
        chart.draw(data, options);
    });
}

// Función para actualizar el historial desde las estadísticas obtenidas
function updateLiveHistoryFromStats(records) {
    // Actualizar la caché local
    historyCache = records.slice(0, 10); // Limitar a 10 registros

    // Actualizar la tabla
    const tbody = document.getElementById('liveHistoryBody');
    tbody.innerHTML = '';
    historyCache.forEach(record => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="padding: 5px;">${record.cedula || ''}</td>
            <td style="padding: 5px;">${record.accion || ''}</td>
            <td style="padding: 5px;">${record.hora || ''}</td>
        `;
        tbody.appendChild(tr);
    });
}

function updateLiveHistory(cedula, accion) {
    const now = new Date().toLocaleTimeString();
    historyCache.unshift({ cedula, accion, hora: now });
    if (historyCache.length > 10) historyCache.pop();

    const tbody = document.getElementById('liveHistoryBody');
    tbody.innerHTML = '';
    historyCache.forEach(record => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="padding: 5px;">${record.cedula}</td>
            <td style="padding: 5px;">${record.accion}</td>
            <td style="padding: 5px;">${record.hora}</td>
        `;
        tbody.appendChild(tr);
    });
}

// Cargar configuración del servidor al iniciar
function aplicarConfiguracionQR(qrBoxSize) {
    if (html5QrCodeScanner) {
        cerrarEscanerQR();
        html5QrCodeScanner = null;
    }
    localStorage.setItem('surpass-qrBoxSize', qrBoxSize);
}

function aplicarIdioma() {
    const language = localStorage.getItem('surpass-language') || 'es';
    const traducciones = {
        es: {
            title: 'SurPass - Control de Acceso',
            placeholderCedula: 'Ingrese cédula o nombre',
            entrada: 'Entrada',
            salida: 'Salida',
            registrar: 'Registrar',
            informacion: 'Información',
            historial: 'Historial',
            limpiar: 'Limpiar',
            finalizar: 'Finalizar',
            opcion_estadisticas: 'Panel Estadísticas',
            opcion_escaner: 'Escaner Nativo',
            tema: 'Cambiar Tema',
            pantalla_completa: 'Pantalla Completa',
            logs: 'Logs',
            evacuacion: 'Modo Evacuación'
        },
        en: {
            title: 'SurPass - Access Control',
            placeholderCedula: 'Enter ID or name',
            entrada: 'Entry',
            salida: 'Exit',
            registrar: 'Register',
            informacion: 'Information',
            historial: 'History',
            limpiar: 'Clear',
            finalizar: 'Finish',
            opcion_estadisticas: 'Statistics Panel',
            opcion_escaner: 'Native Scan',
            tema: 'Change Theme',
            pantalla_completa: 'Full Screen',
            logs: 'Logs',
            evacuacion: 'Evacuation Mode'
        }
    };

    document.title = traducciones[language].title;
    document.getElementById('cedula').placeholder = traducciones[language].placeholderCedula;

    const radioLabels = document.querySelectorAll('.radio-label');
    if (radioLabels.length >= 2) {
        radioLabels[0].textContent = traducciones[language].entrada;
        radioLabels[1].textContent = traducciones[language].salida;
    }
    document.querySelector('input[type="submit"]').value = traducciones[language].registrar;
    document.getElementById('botonEvacuacion').querySelector('strong').textContent = traducciones[language].evacuacion;
}

// Función para hacer el panel de estadísticas arrastrable
function makeStatsPanelDraggable() {
    const statsPanel = document.getElementById('statsPanel');
    const header = statsPanel.querySelector('.stats-panel-header');
    const toggleButton = statsPanel.querySelector('.stats-panel-toggle');
    const content = statsPanel.querySelector('.stats-panel-content');

    let isDragging = false;
    let initialX;
    let initialY;
    let isMinimized = false;

    if (!statsPanel.style.left) statsPanel.style.left = '20px';
    if (!statsPanel.style.bottom) statsPanel.style.bottom = '20px';

    function startDraggingMouse(e) {
        if (e.target === toggleButton) return;
        isDragging = true;
        initialX = e.clientX - parseInt(statsPanel.style.left || 0);
        initialY = e.clientY - (window.innerHeight - parseInt(statsPanel.style.bottom || 0) - statsPanel.offsetHeight);
        statsPanel.style.transition = 'none';
    }

    function dragMouse(e) {
        if (!isDragging) return;
        e.preventDefault();
        updatePosition(e.clientX, e.clientY);
    }

    function stopDraggingMouse() {
        isDragging = false;
        statsPanel.style.transition = 'all 0.3s ease';
    }

    function startDraggingTouch(e) {
        if (e.target === toggleButton) return;
        isDragging = true;
        const touch = e.touches[0];
        initialX = touch.clientX - parseInt(statsPanel.style.left || 0);
        initialY = touch.clientY - (window.innerHeight - parseInt(statsPanel.style.bottom || 0) - statsPanel.offsetHeight);
        statsPanel.style.transition = 'none';
    }

    function dragTouch(e) {
        if (!isDragging) return;
        e.preventDefault();
        const touch = e.touches[0];
        updatePosition(touch.clientX, touch.clientY);
    }

    function stopDraggingTouch() {
        isDragging = false;
        statsPanel.style.transition = 'all 0.3s ease';
    }

    function updatePosition(clientX, clientY) {
        let newX = clientX - initialX;
        let newY = window.innerHeight - (clientY - initialY) - statsPanel.offsetHeight;

        const maxX = window.innerWidth - statsPanel.offsetWidth;
        const maxY = window.innerHeight - statsPanel.offsetHeight;

        newX = Math.max(0, Math.min(newX, maxX));
        newY = Math.max(0, Math.min(newY, maxY));

        statsPanel.style.left = newX + 'px';
        statsPanel.style.bottom = newY + 'px';
        statsPanel.style.top = 'auto';
    }

    header.addEventListener('mousedown', startDraggingMouse);
    document.addEventListener('mousemove', dragMouse);
    document.addEventListener('mouseup', stopDraggingMouse);

    header.addEventListener('touchstart', startDraggingTouch, { passive: false });
    document.addEventListener('touchmove', dragTouch, { passive: false });
    document.addEventListener('touchend', stopDraggingTouch);

    toggleButton.addEventListener('click', function() {
        isMinimized = !isMinimized;
        if (isMinimized) {
            statsPanel.classList.add('minimized');
            toggleButton.innerHTML = '<i class="fas fa-plus"></i>';
            toggleButton.title = 'Maximizar panel';
            statsPanel.style.width = 'auto';
        } else {
            statsPanel.classList.remove('minimized');
            toggleButton.innerHTML = '<i class="fas fa-minus"></i>';
            toggleButton.title = 'Minimizar panel';
            statsPanel.style.width = window.innerWidth <= 768 ? '90%' : '300px';
        }
    });

    if (window.innerWidth <= 768) {
        statsPanel.style.width = '90%';
        statsPanel.style.maxHeight = '50vh';
    } else {
        statsPanel.style.width = '300px';
        statsPanel.style.maxHeight = '80vh';
    }

    actualizarVisibilidadEstadisticas();

    window.addEventListener('resize', function() {
        if (!isMinimized) {
            statsPanel.style.width = window.innerWidth <= 768 ? '90%' : '300px';
            statsPanel.style.maxHeight = window.innerWidth <= 768 ? '50vh' : '80vh';
        }
        const maxX = window.innerWidth - statsPanel.offsetWidth;
        const maxY = window.innerHeight - statsPanel.offsetHeight;
        statsPanel.style.left = Math.min(parseInt(statsPanel.style.left), maxX) + 'px';
        statsPanel.style.bottom = Math.min(parseInt(statsPanel.style.bottom), maxY) + 'px';
    });
}


/**
 * Configura los event listeners específicos del modal de evacuación usando delegación de eventos
 * Se ejecuta cada vez que se muestra el modal para asegurar funcionamiento robusto
 */
function configurarEventListenersModalEvacuacion() {
    console.log('🔧 Configurando event listeners del modal de evacuación con delegación...');
    
    // Usar delegación de eventos para mayor robustez
    const modalContent = document.getElementById('evacuationModalContent');
    if (!modalContent) {
        console.error('❌ Modal content no encontrado');
        return;
    }
    
    // Limpiar event listeners previos para evitar duplicados
    modalContent.removeEventListener('click', handleModalEvacuacionClick);
    
    // Agregar event listener delegado
    modalContent.addEventListener('click', handleModalEvacuacionClick);
    
    console.log('✅ Event listeners configurados con delegación de eventos');
}

/**
 * Manejador de eventos delegado para el modal de evacuación
 */
function handleModalEvacuacionClick(event) {
    const target = event.target;
    
    // Manejar clicks en botones de tipo de evacuación
    if (target.closest('#btnSimulacroModerno')) {
        console.log('🎭 Click en botón simulacro moderno (delegado)');
        event.preventDefault();
        event.stopPropagation();
        seleccionarTipoEvacuacion('simulacro', target.closest('#btnSimulacroModerno'));
        return;
    }
    
    if (target.closest('#btnRealModerno')) {
        console.log('🚨 Click en botón real moderno (delegado)');
        event.preventDefault();
        event.stopPropagation();
        seleccionarTipoEvacuacion('real', target.closest('#btnRealModerno'));
        return;
    }
    
    // Manejar clicks en botones de selección masiva
    if (target.closest('#btnSeleccionarTodosModerno')) {
        console.log('📋 Click en seleccionar todos (delegado)');
        event.preventDefault();
        event.stopPropagation();
        seleccionarTodosModerno();
        return;
    }
    
    if (target.closest('#btnLimpiarSeleccionModerno')) {
        console.log('🧹 Click en limpiar selección (delegado)');
        event.preventDefault();
        event.stopPropagation();
        limpiarSeleccionModerno();
        return;
    }
    
    // Manejar click en botón ejecutar
    if (target.closest('#btnConfirmarSalidas')) {
        console.log('🚀 Click en ejecutar (delegado)');
        event.preventDefault();
        event.stopPropagation();
        procesarEvacuacionDirecta();
        return;
    }
}

/**
 * Muestra el modal principal de evacuación y carga los datos.
 */
function mostrarEvacuacionChecklist() {
    console.log('🚨 Iniciando evacuación unificada desde el cliente...');
    // Cerrar menú y preparar interfaz
    const menuDropdown = document.getElementById('menuDropdown');
    if (menuDropdown) menuDropdown.classList.remove('show');
    const menuButton = document.getElementById('menuButton');
    if (menuButton) menuButton.style.display = 'none';

    // Resetear estado del modal
    resetearModalEvacuacion();

    mostrarLoadingEvacuacion(true, 'Cargando datos de evacuación...'); // Usar la función de loading específica

    google.script.run
        .withSuccessHandler(function(datosEvacuacion) {
            console.log('✅ Datos de evacuación recibidos del servidor:', datosEvacuacion);
            ocultarLoadingEvacuacion(); // Asegurarse de ocultar el loader en éxito

            if (!datosEvacuacion || !datosEvacuacion.success) {
                console.error('❌ Error en datos evacuación recibidos:', datosEvacuacion);
                showCustomNotification('Error: ' + (datosEvacuacion?.message || 'No se pudieron obtener datos de evacuación.'), 'error');
                restaurarInterfazEvacuacion();
                return;
            }

            evacuationData = datosEvacuacion; // Guardar los datos para uso posterior
            renderEvacuationListModern(datosEvacuacion.personasDentro);
            document.getElementById('totalPersonasDentro').textContent = datosEvacuacion.totalDentro;
            document.getElementById('evacuationModal').classList.add('show'); // Mostrar el modal principal de evacuación
            
            // 🔧 CONFIGURAR EVENT LISTENERS DESPUÉS DE MOSTRAR EL MODAL
            configurarEventListenersModalEvacuacion();
            
            console.log('✅ Modal de evacuación mostrado.');
        })
        .withFailureHandler(function(error) {
            console.error('❌ Error al llamar a getEvacuacionDataForClient:', error);
            ocultarLoadingEvacuacion(); // Asegurarse de ocultar el loader en fallo
            showCustomNotification('Error de conexión al cargar evacuación: ' + (error.message || error), 'error');
            restaurarInterfazEvacuacion();
        })
        .getEvacuacionDataForClient(); // Llama a la función del servidor
}

/**
 * Resetea completamente el estado del modal de evacuación
 */
function resetearModalEvacuacion() {
    console.log('🔄 Reseteando modal de evacuación...');
    
    // Resetear variable de tipo seleccionado
    tipoEvacuacionSeleccionado = null;
    
    // Limpiar selección de tipo con estilos forzados
    document.querySelectorAll('.type-card-modern').forEach(btn => {
        btn.classList.remove('selected');
        // Forzar reset de estilos
        btn.style.removeProperty('border-color');
        btn.style.removeProperty('background');
        btn.style.removeProperty('transform');
        btn.style.removeProperty('box-shadow');
        console.log('🧹 Botón reseteado:', btn.id);
    });
    
    // Ocultar información de tipo
    const infoTipo = document.getElementById('infoTipoSeleccionadoModerno');
    if (infoTipo) {
        infoTipo.style.display = 'none';
        infoTipo.innerHTML = '';
    }
    
    // Resetear contador de selección
    const contador = document.getElementById('selectionCountModerno');
    if (contador) {
        contador.textContent = '0';
    }
    
    // Resetear array de personas seleccionadas
    personasSeleccionadasEvacuacion = [];
    
    // Resetear botón ejecutar
    const btnConfirmarSalidas = document.getElementById('btnConfirmarSalidas');
    if (btnConfirmarSalidas) {
        btnConfirmarSalidas.disabled = true;
        btnConfirmarSalidas.className = 'btn-base btn-secondary';
        btnConfirmarSalidas.innerHTML = '<i class="fas fa-play"></i> Ejecutar';
    }
    
    console.log('✅ Modal reseteado completamente');
}

/**
 * Renderiza la lista moderna de personas en el modal de evacuación.
 * @param {Array} personas - Array de objetos de persona.
 */
function renderEvacuationListModern(personas) {
    const personalGrid = document.getElementById('personalGridModerno');
    personalGrid.innerHTML = ''; // Limpiar grid existente
    personasSeleccionadasEvacuacion = []; // Resetear selección

    if (personas.length === 0) {
        personalGrid.innerHTML = `
            <div style="text-align: center; padding: 60px; color: #10b981; grid-column: 1 / -1;">
                <div style="font-size: 4rem; margin-bottom: 20px;">✅</div>
                <h3 style="color: #10b981; margin-bottom: 8px;">¡Edificio Completamente Evacuado!</h3>
                <p style="color: #6b7280;">No hay personal registrado dentro del edificio</p>
            </div>
        `;
    } else {
        personas.forEach((persona, index) => {
            const horaEntrada = persona.horaEntrada ? 
                (persona.horaEntrada instanceof Date ? persona.horaEntrada.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'}) : persona.horaEntrada) : 'N/A';
            
            const personCard = document.createElement('div');
            personCard.className = 'person-card-modern';
            personCard.dataset.cedula = persona.cedula;
            personCard.innerHTML = `
                <input type="checkbox" id="evac-persona-${index}" data-cedula="${persona.cedula}" 
                       data-nombre="${persona.nombre}" data-empresa="${persona.empresa}">
                <div class="person-info">
                    <div class="person-name">${persona.nombre}</div>
                    <div class="person-details">
                        <div><i class="fas fa-id-card"></i> ${persona.cedula}</div>
                        <div><i class="fas fa-building"></i> ${persona.empresa}</div>
                        <div><i class="fas fa-clock"></i> Entrada: ${horaEntrada}</div>
                    </div>
                    <div class="person-status status-active">
                        <i class="fas fa-circle"></i> En edificio
                    </div>
                </div>
            `;
            
            personalGrid.appendChild(personCard);

            // Event listeners para la tarjeta y checkbox
            const checkbox = personCard.querySelector('input[type="checkbox"]');
            
            // Click en la tarjeta selecciona/deselecciona
            personCard.addEventListener('click', function(e) {
                if (e.target.type !== 'checkbox') {
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                }
            });
            
            // Change del checkbox actualiza selección
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    personasSeleccionadasEvacuacion.push(this.dataset.cedula);
                    personCard.classList.add('selected');
                } else {
                    const idx = personasSeleccionadasEvacuacion.indexOf(this.dataset.cedula);
                    if (idx > -1) {
                        personasSeleccionadasEvacuacion.splice(idx, 1);
                    }
                    personCard.classList.remove('selected');
                }
                actualizarContadorSeleccion();
            });
        });
    }
}

/**
 * Selecciona el tipo de evacuación
/**
 * Selecciona todas las personas
 */
function seleccionarTodosModerno() {
    document.querySelectorAll('#personalGridModerno input[type="checkbox"]').forEach(checkbox => {
        if (!checkbox.checked) {
            checkbox.checked = true;
            checkbox.dispatchEvent(new Event('change'));
        }
    });
}

/**
 * Limpia la selección de personas
 */
function limpiarSeleccionModerno() {
    document.querySelectorAll('#personalGridModerno input[type="checkbox"]').forEach(checkbox => {
        if (checkbox.checked) {
            checkbox.checked = false;
            checkbox.dispatchEvent(new Event('change'));
        }
    });
}

/**
 * Actualiza el contador de selección
 */
function actualizarContadorSeleccion() {
    const contador = document.getElementById('selectionCountModerno');
    if (contador) {
        contador.textContent = personasSeleccionadasEvacuacion.length;
    }
    actualizarBotonConfirmar();
}

/**
 * Actualiza el estado del botón confirmar
 */
function actualizarBotonConfirmar() {
    const btnConfirmar = document.getElementById('btnConfirmarSalidas');
    if (btnConfirmar) {
        const tieneSeleccion = personasSeleccionadasEvacuacion.length > 0;
        const tieneTipo = tipoEvacuacionSeleccionado !== null;
        btnConfirmar.disabled = !(tieneSeleccion && tieneTipo);
    }
}

/**
 * Confirma la evacuación seleccionada
 */
function confirmarEvacuacion() {
    if (!tipoEvacuacionSeleccionado || personasSeleccionadasEvacuacion.length === 0) {
        showCustomNotification('Debe seleccionar un tipo de evacuación y al menos una persona', 'warning');
        return;
    }
    
    const mensaje = tipoEvacuacionSeleccionado === 'simulacro' 
        ? `¿Confirmar SIMULACRO de evacuación para ${personasSeleccionadasEvacuacion.length} personas?`
        : `¿Confirmar EVACUACIÓN REAL para ${personasSeleccionadasEvacuacion.length} personas?`;
    
    if (confirm(mensaje)) {
        ejecutarEvacuacion();
    }
}

/**
 * Ejecuta la evacuación
 */
function ejecutarEvacuacion() {
    console.log(`🚨 Ejecutando ${tipoEvacuacionSeleccionado} para ${personasSeleccionadasEvacuacion.length} personas`);
    
    mostrarLoadingEvacuacion(true, `Procesando ${tipoEvacuacionSeleccionado}...`);
    
    const datosEvacuacion = {
        tipo: tipoEvacuacionSeleccionado,
        cedulasSeleccionadas: personasSeleccionadasEvacuacion,
        timestamp: new Date().toISOString()
    };
    
    google.script.run
        .withSuccessHandler(function(resultado) {
            console.log('✅ Evacuación procesada:', resultado);
            ocultarLoadingEvacuacion();
            
            if (resultado.success) {
                const tipoTexto = tipoEvacuacionSeleccionado === 'simulacro' ? 'Simulacro' : 'Evacuación real';
                showCustomNotification(`${tipoTexto} ejecutado correctamente para ${personasSeleccionadasEvacuacion.length} personas`, 'success');
                cerrarEvacuacionChecklist();
                
                // Actualizar datos si es necesario
                if (window.actualizarDatosGenerales) {
                    actualizarDatosGenerales();
                }
            } else {
                showCustomNotification('Error: ' + (resultado.message || 'No se pudo procesar la evacuación'), 'error');
            }
        })
        .withFailureHandler(function(error) {
            console.error('❌ Error al procesar evacuación:', error);
            ocultarLoadingEvacuacion();
            showCustomNotification('Error de conexión: ' + (error.message || error), 'error');
        })
        .procesarEvacuacionUnificada(datosEvacuacion);
}


/**
 * Renderiza la lista de personas en el modal de evacuación.
 * @param {Array} personas - Array de objetos de persona.
 */
function renderEvacuationList(personas) {
    const listaPersonasDentro = document.getElementById('listaPersonasDentro');
    listaPersonasDentro.innerHTML = ''; // Limpiar lista existente
    personasSeleccionadasEvacuacion = []; // Resetear selección

    if (personas.length === 0) {
        listaPersonasDentro.innerHTML = '<li style="text-align: center; padding: 40px; color: var(--success-color); font-size: 20px;">✅ EDIFICIO COMPLETAMENTE EVACUADO</td></tr>';
    } else {
        personas.forEach((persona, index) => {
            const horaEntrada = persona.horaEntrada ? 
                (persona.horaEntrada instanceof Date ? persona.horaEntrada.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'}) : persona.horaEntrada) : 'N/A';
            
            const li = document.createElement('li');
            li.innerHTML = `
                <input type="checkbox" id="evac-persona-${index}" data-cedula="${persona.cedula}" 
                       data-nombre="${persona.nombre}" data-empresa="${persona.empresa}">
                <label for="evac-persona-${index}">
                    <strong>${persona.nombre}</strong><br>
                    <small>Cédula: ${persona.cedula} | Empresa: ${persona.empresa} | Entrada: ${horaEntrada}</small>
                </label>
            `;
            listaPersonasDentro.appendChild(li);

            // Añadir event listener para actualizar la selección
            li.querySelector('input[type="checkbox"]').addEventListener('change', function() {
                if (this.checked) {
                    personasSeleccionadasEvacuacion.push(this.dataset.cedula);
                    li.classList.add('selected');
                } else {
                    const idx = personasSeleccionadasEvacuacion.indexOf(this.dataset.cedula);
                    if (idx > -1) {
                        personasSeleccionadasEvacuacion.splice(idx, 1);
                    }
                    li.classList.remove('selected');
                }
            });
        });
    }
}

/**
 * Cierra el modal principal de evacuación y restaura la interfaz.
 */
function cerrarEvacuacionChecklist() {
    document.getElementById('evacuationModal').classList.remove('show');
    restaurarInterfazEvacuacion();
}

/**
 * Restaura el botón de menú y el estado normal de la interfaz.
 */
function restaurarInterfazEvacuacion() {
    const menuButton = document.getElementById('menuButton');
    if (menuButton) menuButton.style.display = 'flex';
    // Solo ocultar el loading ya que el modal de confirmación fue eliminado
    ocultarLoadingEvacuacion();
}

/**
 * Procesa la evacuación directamente sin modal de confirmación duplicado
 */
function procesarEvacuacionDirecta() {
    console.log('🚀 Procesando evacuación directa...');
    
    // Validar que hay personas seleccionadas
    if (personasSeleccionadasEvacuacion.length === 0) {
        showCustomNotification('Por favor, seleccione al menos una persona para evacuar.', 'warning');
        return;
    }
    
    // Validar que se ha seleccionado un tipo de evacuación
    if (!tipoEvacuacionSeleccionado) {
        showCustomNotification('Por favor, seleccione el tipo de evacuación (SIMULACRO o REAL).', 'warning');
        return;
    }
    
    console.log('✅ Validaciones pasadas. Ejecutando evacuación:', {
        tipo: tipoEvacuacionSeleccionado,
        personas: personasSeleccionadasEvacuacion.length
    });
    
    // Ejecutar la evacuación directamente
    ejecutarEvacuacionConfirmada();
}

/**
 * Función obsoleta - mantenida para compatibilidad
 * @deprecated Use procesarEvacuacionDirecta() instead
 */
function mostrarConfirmacionEvacuacion() {
    console.warn('⚠️ mostrarConfirmacionEvacuacion() es obsoleta. Usando procesarEvacuacionDirecta()');
    procesarEvacuacionDirecta();
}

/**
 * Función obsoleta - mantenida para compatibilidad  
 * @deprecated Modal de confirmación eliminado
 */
function cerrarConfirmacionEvacuacion() {
    console.warn('⚠️ cerrarConfirmacionEvacuacion() es obsoleta - modal eliminado');
}

/**
 * Selecciona el tipo de evacuación (simulacro o real) - versión unificada mejorada.
 * @param {string} tipo - 'simulacro' o 'real'.
 * @param {HTMLElement} button - El botón que fue clickeado.
 */
function seleccionarTipoEvacuacion(tipo, button) {
    console.log('🎯 seleccionarTipoEvacuacion llamada con:', { tipo, button: button?.id });
    
    // Permitir cambio de selección - NO validar si ya está seleccionado
    const tipoAnterior = tipoEvacuacionSeleccionado;
    tipoEvacuacionSeleccionado = tipo;
    
    console.log('📝 Cambio de tipo:', { anterior: tipoAnterior, nuevo: tipoEvacuacionSeleccionado });
    
    // Interface moderna unificada - siempre se usa ahora
    console.log('🎨 Procesando interfaz moderna unificada');
    
    // Limpiar selección anterior en TODOS los botones modernos
    const botonesModernos = document.querySelectorAll('.type-card-modern');
    console.log('🧹 Limpiando selección de', botonesModernos.length, 'botones modernos');
    
    botonesModernos.forEach(btn => {
        btn.classList.remove('selected');
        // Resetear estilos completamente
        btn.style.borderColor = '';
        btn.style.background = '';
        btn.style.transform = '';
        btn.style.boxShadow = '';
        console.log('🧹 Botón limpiado:', btn.id);
    });
    
    // Seleccionar nuevo botón si existe
    if (button) {
        console.log('✅ Aplicando selección a:', button.id);
        button.classList.add('selected');
        
        // Agregar efectos visuales específicos con !important para forzar
        if (tipo === 'simulacro') {
            button.style.setProperty('border-color', '#7c3aed', 'important');
            button.style.setProperty('background', 'linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%)', 'important');
            button.style.setProperty('transform', 'translateY(-2px)', 'important');
            button.style.setProperty('box-shadow', '0 8px 20px rgba(124, 58, 237, 0.3)', 'important');
        } else {
            button.style.setProperty('border-color', '#dc2626', 'important');
            button.style.setProperty('background', 'linear-gradient(135deg, #fef2f2 0%, #fecaca 100%)', 'important');
            button.style.setProperty('transform', 'translateY(-2px)', 'important');
            button.style.setProperty('box-shadow', '0 8px 20px rgba(220, 38, 38, 0.3)', 'important');
        }
        
        console.log('🎨 Estilos aplicados a:', button.id, 'para tipo:', tipo);
    }
    
    // Mostrar información del tipo seleccionado
    const infoDiv = document.getElementById('infoTipoSeleccionadoModerno');
    console.log('📄 infoTipoSeleccionadoModerno encontrado:', !!infoDiv);
    
    if (infoDiv) {
        if (tipo === 'simulacro') {
            infoDiv.innerHTML = `
                <div class="info-tipo-seleccionado info-simulacro">
                    <h5><i class="fas fa-theater-masks"></i> Simulacro de Evacuación</h5>
                    <p>• No se registrarán salidas permanentes en el historial<br>
                    • Solo se creará un registro de auditoría<br>
                    • Las personas podrán volver a ingresar normalmente</p>
                </div>
            `;
        } else {
            infoDiv.innerHTML = `
                <div class="info-tipo-seleccionado info-real">
                    <h5><i class="fas fa-exclamation-triangle"></i> Evacuación Real</h5>
                    <p>• Se registrarán salidas permanentes en el historial<br>
                    • Se enviarán notificaciones de emergencia<br>
                    • Las personas deberán volver a ingresar manualmente</p>
                </div>
            `;
        }
        infoDiv.style.display = 'block';
        console.log('📄 Información del tipo mostrada para:', tipo);
    }
    
    // Actualizar estado del botón ejecutar
    const btnConfirmarSalidas = document.getElementById('btnConfirmarSalidas');
    if (btnConfirmarSalidas) {
        btnConfirmarSalidas.disabled = false;
        if (tipo === 'simulacro') {
            btnConfirmarSalidas.className = 'btn-base btn-simulacro';
            btnConfirmarSalidas.innerHTML = '<i class="fas fa-theater-masks"></i> Ejecutar Simulacro';
        } else {
            btnConfirmarSalidas.className = 'btn-base btn-danger';
            btnConfirmarSalidas.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Ejecutar Evacuación';
        }
        console.log('🔄 Botón ejecutar actualizado para:', tipo);
    }
    
    console.log('✅ seleccionarTipoEvacuacion completada exitosamente');
}

/**
 * Muestra un modal con el listado de personas que aún quedan dentro.
 * @param {Array} personasFaltantes - Array de objetos de persona ({cedula, nombre, empresa, horaEntrada}).
 */
function showMissingPersonnelNotification(personasFaltantes) {
    if (!personasFaltantes || personasFaltantes.length === 0) {
        return; // No hay nadie que mostrar
    }

    let messageHtml = `<p style="font-size: 18px; margin-bottom: 20px;">Las siguientes personas aún permanecen dentro de la instalación:</p>`;
    messageHtml += `<div style="max-height: 250px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 10px; background: var(--theme-card-bg);">`;
    messageHtml += `<ul style="list-style: none; padding: 0; margin: 0;">`;

    personasFaltantes.forEach(p => {
        messageHtml += `
            <li style="padding: 8px 0; border-bottom: 1px dashed var(--theme-border); display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong style="color: var(--theme-text);">${p.nombre || 'N/A'}</strong> (<span style="color: var(--theme-text);">${p.cedula || 'N/A'}</span>)<br>
                    <small style="color: var(--theme-text); opacity: 0.7;">Empresa: ${p.empresa || 'N/A'} | Entrada: ${p.horaEntrada || 'N/A'}</small>
                </div>
                <i class="fas fa-exclamation-triangle" style="color: #ff9800;"></i>
            </li>`;
    });
    messageHtml += `</ul></div>`;
    messageHtml += `<p style="font-size: 14px; color: var(--theme-text); opacity: 0.8; margin-top: 20px;">Recuerde que un simulacro no modifica los registros reales.</p>`;

    // Use the existing custom notification modal
    const modal = document.getElementById('customNotificationModal');
    const header = modal.querySelector('.custom-modal-header');
    const icon = document.getElementById('notificationIcon');
    const title = document.getElementById('notificationTitle');
    const msg = document.getElementById('notificationMessage');
    const buttonsDiv = document.getElementById('notificationButtons');

    // Clear previous classes and set new ones for warning/info
    header.className = 'custom-modal-header warning'; // Set to warning for alert
    icon.className = 'fas fa-exclamation-triangle';
    title.textContent = 'Personas aún dentro (Simulacro)';
    msg.innerHTML = messageHtml; // Use innerHTML for custom content

    buttonsDiv.innerHTML = ''; // Clear existing buttons
    const okBtn = document.createElement('button');
    okBtn.className = 'btn-base btn-primary';
    okBtn.textContent = 'Aceptar';
    okBtn.addEventListener('click', function() {
        modal.classList.remove('show');
    });
    buttonsDiv.appendChild(okBtn);

    modal.classList.add('show');
}

/**
 * Ejecuta la evacuación confirmada (simulacro o real).
 */
function ejecutarEvacuacionConfirmada() {
    if (!tipoEvacuacionSeleccionado) {
        showCustomNotification('Por favor, seleccione un tipo de evacuación (Simulacro o Evento Real).', 'warning');
        return;
    }
    if (personasSeleccionadasEvacuacion.length === 0) {
        showCustomNotification('No hay personas seleccionadas para evacuar.', 'warning');
        return;
    }

    const mensajeConfirmacion = tipoEvacuacionSeleccionado === 'simulacro'
        ? `¿Confirma el SIMULACRO de evacuación para ${personasSeleccionadasEvacuacion.length} persona(s)?\n\nEsto NO afectará los registros reales de entrada/salida.`
        : `¡ALERTA! ¿Confirma la EVACUACIÓN REAL para ${personasSeleccionadasEvacuacion.length} persona(s)?\n\nEsta acción registrará sus salidas PERMANENTEMENTE y NO se puede deshacer.`;

    showCustomNotification(mensajeConfirmacion, 'warning', true, function(confirm) {
        if (!confirm) {
            return;
        }

        cerrarConfirmacionEvacuacion(); // Cerrar el modal de confirmación
        mostrarLoadingEvacuacion(true, 'Procesando evacuación...');

        const parametrosEvacuacion = {
            cedulas: personasSeleccionadasEvacuacion,
            tipo: tipoEvacuacionSeleccionado
        };

        // ✅ CORRECCIÓN CRÍTICA: Llamar a la función correcta según el tipo
        if (tipoEvacuacionSeleccionado === 'simulacro') {
            // Para simulacros, usar la función específica que NO modifica el historial
            google.script.run
                .withSuccessHandler(function(resultado) {
                    ocultarLoadingEvacuacion();
                    if (resultado.success) {
                        showCustomNotification(`✅ SIMULACRO completado: ${resultado.message} - NO se modificó el historial real`, 'success');
                        // Volver a cargar la lista de personas en el modal principal de evacuación
                        mostrarEvacuacionChecklist();

                        // Mostrar faltantes si hay personas dentro
                        if (resultado.personasDentroActualizadas && resultado.personasDentroActualizadas.length > 0) {
                            showMissingPersonnelNotification(resultado.personasDentroActualizadas);
                        }
                    } else {
                        showCustomNotification(`❌ Error en simulacro: ${resultado.message}`, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    ocultarLoadingEvacuacion();
                    showCustomNotification('❌ Error al comunicarse con el servidor: ' + error.message, 'error');
                })
                .procesarSimulacroEvacuacion(parametrosEvacuacion.cedulas, 'Simulacro ejecutado desde formulario web');
        } else {
            // Para evacuaciones reales, usar la función unificada normal
            google.script.run
                .withSuccessHandler(function(resultado) {
                    ocultarLoadingEvacuacion();
                    if (resultado.success) {
                        showCustomNotification(`✅ Evacuación REAL completada: ${resultado.message}`, 'success');
                        
                        // 🔥 ACTUALIZAR INMEDIATAMENTE LA INTERFAZ LOCAL
                        actualizarInterfazPostEvacuacionReal(personasSeleccionadasEvacuacion, resultado);
                        
                        // Resetear selecciones
                        personasSeleccionadasEvacuacion = [];
                        tipoEvacuacionSeleccionado = null;
                        
                        // Mostrar faltantes si hay personas dentro (basado en datos del servidor)
                        if (resultado.personasDentroActualizadas && resultado.personasDentroActualizadas.length > 0) {
                            setTimeout(() => {
                                showMissingPersonnelNotification(resultado.personasDentroActualizadas);
                            }, 1500); // Delay para mostrar después de la notificación principal
                        }
                    } else {
                        showCustomNotification(`❌ Error en evacuación real: ${resultado.message}`, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    ocultarLoadingEvacuacion();
                    showCustomNotification('❌ Error al comunicarse con el servidor: ' + error.message, 'error');
                })
                .procesarEvacuacionUnificada(parametrosEvacuacion);
        }
    });
}


/**
 * Función de loading específica para evacuación
 */
function mostrarLoadingEvacuacion(mostrar, mensaje = 'Procesando...') {
    let loadingDiv = document.getElementById('evacuationLoadingOverlay');
    let loadingText = document.getElementById('evacuationLoadingText');
    
    if (!loadingDiv) {
        // Crear elemento de loading si no existe
        loadingDiv = document.createElement('div');
        loadingDiv.id = 'evacuationLoadingOverlay';
        loadingDiv.className = 'evacuation-loading'; // Usar clase CSS
        
        loadingDiv.innerHTML = `
            <div class="evacuation-spinner spinner"></div>
            <p id="evacuationLoadingText"></p>
        `;
        
        document.body.appendChild(loadingDiv);
        loadingText = document.getElementById('evacuationLoadingText'); // Re-obtener referencia
    }
    
    if (loadingText) {
        loadingText.textContent = mensaje;
    }

    if (mostrar) {
        loadingDiv.style.display = 'flex';
    } else {
        loadingDiv.style.display = 'none';
    }
}

function ocultarLoadingEvacuacion() {
    const loadingDiv = document.getElementById('evacuationLoadingOverlay');
    if (loadingDiv) {
        loadingDiv.style.display = 'none';
    }
}

/**
 * Actualiza la interfaz inmediatamente después de una evacuación real exitosa
 * @param {Array} cedulasEvacuadas - Array de cédulas de personas evacuadas
 * @param {Object} resultado - Resultado del servidor con datos actualizados
 */
function actualizarInterfazPostEvacuacionReal(cedulasEvacuadas, resultado) {
    console.log('🔄 Actualizando interfaz post-evacuación real para:', cedulasEvacuadas);
    console.log('📊 Datos del servidor:', resultado);
    
    // 1. Remover personas evacuadas de los datos locales
    if (evacuationData && evacuationData.personasDentro) {
        const personasOriginales = evacuationData.personasDentro.length;
        evacuationData.personasDentro = evacuationData.personasDentro.filter(persona => 
            !cedulasEvacuadas.includes(persona.cedula)
        );
        const personasRestantes = evacuationData.personasDentro.length;
        console.log(`👥 Personas removidas: ${personasOriginales - personasRestantes}, Restantes: ${personasRestantes}`);
        
        // 2. Actualizar contador principal con datos del servidor si están disponibles
        const totalPersonasElement = document.getElementById('totalPersonasDentro');
        if (totalPersonasElement) {
            const totalReal = resultado.totalPersonasRestantes !== undefined ? resultado.totalPersonasRestantes : personasRestantes;
            totalPersonasElement.textContent = totalReal;
            totalPersonasElement.style.animation = 'countUp 0.5s ease-out';
        }
        
        // 3. Re-renderizar la lista sin las personas evacuadas
        // Usar datos del servidor si están disponibles
        if (resultado.personasDentroActualizadas && resultado.personasDentroActualizadas.length >= 0) {
            renderEvacuationListModern(resultado.personasDentroActualizadas);
            evacuationData.personasDentro = resultado.personasDentroActualizadas; // Sincronizar con servidor
        } else {
            renderEvacuationListModern(evacuationData.personasDentro);
        }
        
        // 4. Resetear formulario de selección
        resetearSeleccionTipo();
        
        // 5. Actualizar contador de selección
        actualizarContadorSeleccion();
        
        // 6. Mostrar feedback visual de evacuación completada
        mostrarFeedbackEvacuacionReal(cedulasEvacuadas.length);
        
        // 7. Actualizar estadísticas INMEDIATAMENTE con datos del servidor
        if (resultado.estadisticasActualizadas) {
            console.log('📈 Actualizando estadísticas con datos del servidor:', resultado.estadisticasActualizadas);
            actualizarEstadisticasConDatos(resultado.estadisticasActualizadas);
        } else {
            // Fallback: actualizar usando el método tradicional
            actualizarEstadisticasPostEvacuacion(cedulasEvacuadas.length);
        }
    }
}

/**
 * Actualiza las estadísticas inmediatamente después de una evacuación real
 * @param {number} cantidadEvacuados - Número de personas evacuadas
 */
/**
 * Actualiza las estadísticas con datos específicos del servidor
 * @param {Object} estadisticas - Datos de estadísticas del servidor
 */
function actualizarEstadisticasConDatos(estadisticas) {
    console.log('📊 Actualizando estadísticas con datos específicos:', estadisticas);
    
    if (!mostrarEstadisticas) return;
    
    // Actualizar contadores directamente con los datos del servidor
    if (entradasLiveSpan && estadisticas.entradas !== undefined) {
        entradasLiveSpan.textContent = estadisticas.entradas;
        entradasLiveSpan.style.animation = 'countUp 0.5s ease';
        setTimeout(() => {
            entradasLiveSpan.style.animation = '';
        }, 500);
    }
    
    if (salidasLiveSpan && estadisticas.salidas !== undefined) {
        salidasLiveSpan.textContent = estadisticas.salidas;
        salidasLiveSpan.style.animation = 'countUp 0.5s ease';
        setTimeout(() => {
            salidasLiveSpan.style.animation = '';
        }, 500);
    }
    
    // Actualizar gráfica
    if (estadisticas.entradas !== undefined && estadisticas.salidas !== undefined) {
        drawMiniChart(estadisticas.entradas, estadisticas.salidas);
    }
    
    // Programar una actualización completa después de un momento para sincronizar
    setTimeout(() => {
        updateStatsPanel();
    }, 1000);
}

function actualizarEstadisticasPostEvacuacion(cantidadEvacuados) {
    // Actualizar contador de salidas en las estadísticas
    if (salidasLiveSpan) {
        const salidasActuales = parseInt(salidasLiveSpan.textContent) || 0;
        const nuevasSalidas = salidasActuales + cantidadEvacuados;
        salidasLiveSpan.textContent = nuevasSalidas;
        salidasLiveSpan.style.animation = 'countUp 0.5s ease';
        setTimeout(() => {
            salidasLiveSpan.style.animation = '';
        }, 500);
    }
    
    // Forzar actualización completa de estadísticas desde el servidor después de un delay
    setTimeout(() => {
        updateStatsPanel();
    }, 2000);
}

/**
 * Resetea la selección de tipo de evacuación
 */
function resetearSeleccionTipo() {
    // Limpiar botones de tipo
    const botonesModernos = document.querySelectorAll('.type-card-modern');
    botonesModernos.forEach(btn => {
        btn.classList.remove('selected');
        btn.style.borderColor = '';
        btn.style.background = '';
    });
    
    // Ocultar información del tipo
    const infoDiv = document.getElementById('infoTipoSeleccionadoModerno');
    if (infoDiv) {
        infoDiv.style.display = 'none';
        infoDiv.innerHTML = '';
    }
    
    // Deshabilitar botón ejecutar
    const btnConfirmarSalidas = document.getElementById('btnConfirmarSalidas');
    if (btnConfirmarSalidas) {
        btnConfirmarSalidas.disabled = true;
        btnConfirmarSalidas.className = 'btn-base btn-primary';
        btnConfirmarSalidas.innerHTML = '<i class="fas fa-play"></i> Ejecutar';
    }
}

/**
 * Muestra feedback visual de evacuación completada
 */
function mostrarFeedbackEvacuacionReal(cantidadEvacuados) {
    // Agregar clase temporal para animación
    const modalContent = document.getElementById('evacuationModalContent');
    if (modalContent) {
        modalContent.style.borderColor = '#10b981';
        modalContent.style.boxShadow = '0 0 20px rgba(16, 185, 129, 0.3)';
        
        // Quitar el efecto después de 2 segundos
        setTimeout(() => {
            modalContent.style.borderColor = '';
            modalContent.style.boxShadow = '';
        }, 2000);
    }
}

// Cierre de modales de vista previa
function cerrarVistaPrevia() {
    document.getElementById('vistaPrevia').style.display = 'none';
    menuButton.style.display = 'flex'; // Restaurar botón de menú
}

function cerrarVistaPreviaHistorial() {
    document.getElementById('vistaPreviaHistorial').style.display = 'none';
    menuButton.style.display = 'flex'; // Restaurar botón de menú
}

// Funciones para el log overlay
function showLogOverlay() {
    document.getElementById('logOverlay').style.display = 'flex';
    document.getElementById('menuDropdown').classList.remove('show');
    menuButton.style.display = 'none'; // Ocultar el botón de menú
}

function closeLogOverlay() {
    document.getElementById('logOverlay').style.display = 'none';
    menuButton.style.display = 'flex'; // Restaurar botón de menú
}

    </script>
</body>
</html>
